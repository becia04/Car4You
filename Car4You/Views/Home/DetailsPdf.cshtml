@using System.IO

@model Car4You.Models.Car
<link href="~/css/pdf_export.css" rel="stylesheet" />
<img src="~/temp/qr_@(Model.Id).png" alt="QR Code" class="pdf-qr-code" />

<div class="pdf-main-content">
    <div class="pdf-details-header">
        <div class="pdf-header-wrapper">
            <img src="~/@Model.BodyTypes.Icon.TrimStart('~', '/','\\')" class="pdf-icon" />

            <span class="pdf-title">@Model.Title</span>
        </div>
    </div>
    <div class="pdf-line"></div>
    <div class="pdf-car-details-container">
        <!-- Kolumna lewa: główne zdjęcie -->
        <div class="pdf-left-gallery">
            @{
                var mainPhoto = Model.Photos.FirstOrDefault(p => p.IsMain)
                ?? Model.Photos.FirstOrDefault()
                ?? new Photo { PhotoPath = "/no-photo.png" };
            }

            <img src="~/@mainPhoto.PhotoPath.TrimStart('~', '/', '\\')" class="pdf-main-photo" />

        </div>

        <!-- Kolumna prawa: informacje o aucie -->
        <div class="pdf-right-info">
            <div class="pdf-header">
                @if (!string.IsNullOrEmpty(Model.CarModel?.Brand?.Icon))
                {
                    <img src="~/@Model.CarModel.Brand.Icon.TrimStart('~', '/', '\\')"
                         class="pdf-brand-logo" />
                }

                <div class="pdf-title-group">
                    <h2 class="pdf-right-title">@Model.CarModel?.Brand?.Name @Model.CarModel?.Name</h2>
                    @if (Model.Version != null)
                    {
                        <p class="pdf-version">@Model.Version.Name</p>
                    }
                </div>
            </div>

            <div class="pdf-car-specs">
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <td style="width:50%; vertical-align: top;">
                            <div class="pdf-info-item">
                                <img src="~/icons/year.png" alt="Rok produkcji"/>
                                 @Model.Year
                            </div>
                            <div class="pdf-info-item">
                                <img src="~/icons/mileage.png" alt="Napęd"/> 
                                @($"{Model.Mileage:n0}") km
                            </div>
                        </td>
                        <td style="width:50%; vertical-align: top;">
                            <div class="pdf-info-item">
                                <img src="~/icons/petrol.png" alt="Typ paliwa"/>
                                @Model.FuelType
                            </div>
                            <div class="pdf-info-item">
                                <img src="~/icons/gearbox.png" alt="Skrzynia biegów"/>
                                @Model.Gearbox
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align:center; padding-top:10px;">
                            <div class="pdf-info-item">
                                <img src="~/@Model.BodyTypes.Icon.TrimStart('~', '/', '\\')" class="pdf-icon" />
                                @Model.BodyTypes?.Name
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="pdf-car-price">
                @if (Model.OldPrice.HasValue && Model.NewPrice.HasValue && Model.OldPrice > Model.NewPrice)
                {
                    <p class="old-price"><strong>Poprzednia cena:</strong> <span>@($"{Model.OldPrice:n0}") PLN</span></p>
                }
                <p class="new-price">@($"{Model.NewPrice:n0}") PLN</p>
            </div>

        </div>
    </div>

    <!--Informacje szczegółowe-->
    <div class="pdf-section">
        <h2 class="pdf-section-title">Szczegóły techniczne</h2>
        <table class="pdf-details-table">
            <tr>
                <td>
                    <strong><img src="~/icons/engine.png" class="pdf-icon" alt="Silnik"/> Silnik i osiągi</strong><br />
                    <b>Pojemność:</b> @($"{Model.CubicCapacity:n0}") cm³<br />
                    <b>Moc silnika:</b> @Model.EnginePower KM (@ViewBag.EnginePowerKW kW)<br />
                    <b>Skrzynia biegów:</b> @Model.Gearbox<br />
                    <b>Napęd:</b> @Model.Drive<br />
                    <b>Paliwo:</b> @Model.FuelType<br />
                    <b>Przebieg:</b> @($"{Model.Mileage:n0}") km
                </td>
                <td>
                    <strong><img src="~/icons/car.png" class="pdf-icon" alt="Ikona"/> Nadwozie i wymiary</strong><br />
                    <b>Rodzaj nadwozia:</b> @Model.BodyTypes?.Name<br />
                    <b>Kolor:</b> @Model.Color @Model.ColorType?.ToLower()<br />
                    <b>Liczba drzwi:</b> @Model.Door<br />
                    <b>Liczba miejsc:</b> @Model.Seat
                </td>
                <td>
                    <strong><img src="~/icons/origin.png" class="pdf-icon" alt="Pochodzenie"/> Pochodzenie i właściciel</strong><br />
                    <b>Rok produkcji:</b> @Model.Year<br />
                    <b>Kraj pochodzenia:</b> @Model.Origin<br />
                    @if (Model.FirstOwner == true)
                    {
                        <text>Pierwszy właściciel<br /></text>
                    }
                    @if (Model.PolishPlate == true)
                    {
                        <text>Zarejestrowany w PL<br /></text>
                    }
                    else
                    {

                        <text>Przygotowany do rejestracji<br /></text>
                    }
                    @if (Model.AccidentFree == true)
                    {
                        <text>Bezwypadkowy<br /></text>
                    }
                    @if (!string.IsNullOrEmpty(Model.VIN) && Model.VIN != "0")
                    {
                        <text><b>VIN:</b> @Model.VIN<br /></text>
                    }
                </td>
            </tr>
        </table>
    </div>

    <!--Wyposażenie-->
    <section class="pdf-section">
        <h2 class="pdf-section-title">Wyposażenie</h2>

        @foreach (var group in Model.CarEquipments
                .GroupBy(e => e.Equipment.EquipmentType)
                .OrderBy(g => g.Key.Name))
        {
            var equipmentType = group.Key;

            
            <div class="pdf-equipment-group">
                <h3 class="pdf-equipment-title">
                    @if (!string.IsNullOrEmpty(equipmentType.Icon))
                    {
                        <img src="~/@equipmentType.Icon.TrimStart('~', '/', '\\')"
                             class="pdf-equipment-type-icon" />
                    }
                    @equipmentType.Name
                </h3>

                <table class="pdf-equipment-table">
                    @foreach (var item in group
                                    .GroupBy(e => e.Equipment.Name.Split(" -")[0])
                                    .Select(g =>
                                    {
                                        var baseName = g.Key;
                                        var suffixes = g.Select(e => e.Equipment.Name.Contains(" -") ? e.Equipment.Name.Split(" -")[1] : null)
                                    .Where(s => s != null)
                                    .ToList();
                                        var fullName = suffixes.Any() ? $"{baseName} – {string.Join(", ", suffixes)}" : baseName;
                                        var icon = g.First().Equipment.Icon;
                                        return new { fullName, icon };
                                    })
                                    .OrderBy(x => x.fullName))
                    {
                        <tr class="pdf-equipment-item">
                            <td>
                                @if (!string.IsNullOrEmpty(item.icon))
                                {
                                    <img src="~/@item.icon.TrimStart('~', '/', '\\')"
                                         class="pdf-equipment-icon" />
                                }
                                @item.fullName
                            </td>
                        </tr>
                    }
                </table>
            </div>
        }
    </section>

</div>