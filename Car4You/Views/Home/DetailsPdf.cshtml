@using System.IO

@model Car4You.Models.Car

<link href="~/css/pdf_export.css" rel="stylesheet" />
<div class="pdf-main-content">
    <div class="pdf-details-header">
        @{
            var bodyPath = System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", Model.BodyTypes.Icon.TrimStart('\\', '/'));
            var bodyUrl = new Uri(bodyPath).AbsoluteUri;

        }
        <div class="pdf-header-wrapper">
            <img src="@bodyUrl" class="pdf-icon" />
            <span class="pdf-title">@Model.Title</span>
        </div>
    </div>
    <div class="pdf-line"></div>
    <div class="pdf-car-details-container">
        <!-- Kolumna lewa: główne zdjęcie -->
        <div class="pdf-left-gallery">
            @{
                var mainPhoto = Model.Photos.FirstOrDefault(p => p.IsMain) ?? Model.Photos.FirstOrDefault();
                if (mainPhoto == null)
                {
                    mainPhoto = new Photo { PhotoPath = "/no-photo.png", IsMain = true };
                }

                var photoPath = System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", mainPhoto.PhotoPath.TrimStart('\\', '/'));
                var photoUrl = new Uri(photoPath).AbsoluteUri;
            }
            <img src="@photoUrl" alt="@Model.Title" class="pdf-main-photo" />
        </div>

        <!-- Kolumna prawa: informacje o aucie -->
        <div class="pdf-right-info">
            <div class="pdf-header">
                @if (!string.IsNullOrEmpty(Model.CarModel?.Brand?.Icon))
                {
                    var brandIconPath = System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", Model.CarModel.Brand.Icon.TrimStart('\\', '/'));
                    var brandIconUrl = new Uri(brandIconPath).AbsoluteUri;
                    <img src="@brandIconUrl" alt="Logo @Model.CarModel.Brand.Name" class="pdf-brand-logo" />
                }
                <div class="pdf-title-group">
                    <h2 class="pdf-right-title">@Model.CarModel?.Brand?.Name @Model.CarModel?.Name</h2>
                    @if (Model.Version != null)
                    {
                        <p class="pdf-version">@Model.Version.Name</p>
                    }
                </div>
            </div>
            @{
                var yearPath = System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", "icons", "year.png");
                var yearUrl = new Uri(yearPath).AbsoluteUri;
                var mileageUrl = new Uri(System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", "icons", "mileage.png")).AbsoluteUri;
                var petrolUrl = new Uri(System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", "icons", "petrol.png")).AbsoluteUri;
                var gearboxUrl = new Uri(System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", "icons", "gearbox.png")).AbsoluteUri;
                var fuelUrl = new Uri(System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", "icons", "petrol.png")).AbsoluteUri;
            }


            <div class="pdf-car-specs">
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <td style="width:50%; vertical-align: top;">
                            <div class="pdf-info-item">
                                <img src="@yearUrl" alt="Rok" />
                                 @Model.Year
                            </div>
                            <div class="pdf-info-item">
                                <img src="@mileageUrl" alt="Przebieg" /> @($"{Model.Mileage:n0}") km
                            </div>
                        </td>
                        <td style="width:50%; vertical-align: top;">
                            <div class="pdf-info-item">
                                <img src="@fuelUrl" alt="Paliwo" /> @Model.FuelType
                            </div>
                            <div class="pdf-info-item">
                                <img src="@gearboxUrl" alt="Skrzynia" /> @Model.Gearbox
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align:center; padding-top:10px;">
                            <div class="pdf-info-item">
                                <img src="@bodyUrl" alt="Skrzynia" /> @Model.BodyTypes?.Name
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="pdf-car-price">
                @if (Model.OldPrice.HasValue && Model.NewPrice.HasValue && Model.OldPrice > Model.NewPrice)
                {
                    <p class="old-price"><strong>Poprzednia cena:</strong> <span>@($"{Model.OldPrice:n0}") PLN</span></p>
                }
                <p class="new-price">@($"{Model.NewPrice:n0}") PLN</p>
            </div>

        </div>
    </div>

    <!--Informacje szczegółowe-->
    @{
        var engineUrl = System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", "icons", "engine.png");
        var carUrl = System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", "icons", "car.png");
        var originUrl = System.IO.Path.Combine(System.IO.Directory.GetCurrentDirectory(), "wwwroot", "icons", "origin.png");
    }
    <div class="pdf-section">
        <h2 class="pdf-section-title">Szczegóły techniczne</h2>
        <table class="pdf-details-table">
            <tr>
                <td>
                    <strong><img src="@engineUrl" class="pdf-icon" alt="Silnik" /> Silnik i osiągi</strong><br />
                    <b>Pojemność:</b> @($"{Model.CubicCapacity:n0}") cm³<br />
                    <b>Moc silnika:</b> @Model.EnginePower KM (@ViewBag.EnginePowerKW kW)<br />
                    <b>Skrzynia biegów:</b> @Model.Gearbox<br />
                    <b>Napęd:</b> @Model.Drive<br />
                    <b>Paliwo:</b> @Model.FuelType<br />
                    <b>Przebieg:</b> @($"{Model.Mileage:n0}") km
                </td>
                <td>
                    <strong><img src="@carUrl" class="pdf-icon" alt="Nadwozie" /> Nadwozie i wymiary</strong><br />
                    <b>Rodzaj nadwozia:</b> @Model.BodyTypes?.Name<br />
                    <b>Kolor:</b> @Model.Color @Model.ColorType?.ToLower()<br />
                    <b>Liczba drzwi:</b> @Model.Door<br />
                    <b>Liczba miejsc:</b> @Model.Seat
                </td>
                <td>
                    <strong><img src="@originUrl" class="pdf-icon" alt="Pochodzenie" /> Pochodzenie i właściciel</strong><br />
                    <b>Rok produkcji:</b> @Model.Year<br />
                    <b>Kraj pochodzenia:</b> @Model.Origin<br />
                    @if (Model.FirstOwner == true)
                    {
                        <text>Pierwszy właściciel<br /></text>
                    }
                    @if (Model.PolishPlate == true)
                    {
                        <text>Zarejestrowany w PL<br /></text>
                    }
                    else
                    {

                        <text>Przygotowany do rejestracji<br /></text>
                    }
                    @if (Model.AccidentFree == true)
                    {
                        <text>Bezwypadkowy<br /></text>
                    }
                    @if (!string.IsNullOrEmpty(Model.VIN) && Model.VIN != "0")
                    {
                        <text><b>VIN:</b> @Model.VIN<br /></text>
                    }
                </td>
            </tr>
        </table>
    </div>

    <!--Wyposażenie-->
    <section class="pdf-section">
        <h2 class="pdf-section-title">Wyposażenie</h2>

        @foreach (var group in Model.CarEquipments
                .GroupBy(e => e.Equipment.EquipmentType)
                .OrderBy(g => g.Key.Name))
        {
            var equipmentType = group.Key;

            // Pobieramy ikonę dla tego typu wyposażenia
            var eqTypePath = System.IO.Path.Combine(
            System.IO.Directory.GetCurrentDirectory(),
            "wwwroot",
            equipmentType.Icon.TrimStart('\\', '/')
            );
            var eqTypeUrl = new Uri(eqTypePath).AbsoluteUri;
            <div class="pdf-equipment-group">
                <h3 class="pdf-equipment-title">
                    @if (!string.IsNullOrEmpty(equipmentType.Icon))
                    {
                        <img src="@eqTypeUrl" alt="@equipmentType.Name" class="pdf-equipment-type-icon" />
                    }
                    @equipmentType.Name
                </h3>

                <table class="pdf-equipment-table">
                    @foreach (var item in group
                                    .GroupBy(e => e.Equipment.Name.Split(" -")[0])
                                    .Select(g =>
                                    {
                                        var baseName = g.Key;
                                        var suffixes = g.Select(e => e.Equipment.Name.Contains(" -") ? e.Equipment.Name.Split(" -")[1] : null)
                                    .Where(s => s != null)
                                    .ToList();
                                        var fullName = suffixes.Any() ? $"{baseName} – {string.Join(", ", suffixes)}" : baseName;
                                        var icon = g.First().Equipment.Icon;
                                        return new { fullName, icon };
                                    })
                                    .OrderBy(x => x.fullName))
                    {
                        // Ścieżka do ikonki konkretnego wyposażenia
                        var eqPath = System.IO.Path.Combine(
                        System.IO.Directory.GetCurrentDirectory(),
                        "wwwroot",
                        item.icon.TrimStart('\\', '/')
                        );
                        var eqUrl = new Uri(eqPath).AbsoluteUri;
                        <tr class="pdf-equipment-item">
                            <td>
                                @if (!string.IsNullOrEmpty(item.icon))
                                {
                                    <img src="@eqUrl" alt="@item.fullName" class="pdf-equipment-icon" />
                                }
                                @item.fullName
                            </td>
                        </tr>
                    }
                </table>
            </div>
        }
    </section>
</div>