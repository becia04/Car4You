@using Car4You.Helper
@using Newtonsoft.Json
@using Newtonsoft.Json.Serialization
@model Car4You.ViewModels.CarViewModel
<link href="~/css/carform.css" rel="stylesheet" />
@{
    ViewData["Title"] = (Model.Car?.Id > 0 ? "Edytuj auto" : "Dodaj auto");
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
@if(Model.Car?.Id>0)
{
    <div style="margin-top:180px;">
    <h1 style="margin:0; display:inline-block; color:#24435e; font-weight:500;">
        <a asp-action="Details" asp-controller="Home" asp-route-id="@Model.Car.Id" style="margin-right:1rem;">
    <i class="fas fa-arrow-left btn_previous"></i>
</a>
        Edytuj auto
    </h1>
    <div class="line" style="margin-bottom:2rem;"></div>
    </div>
}
else
{
        <div style="margin-top:180px;">
        <h1 style="margin:0; display:inline-block; color:#24435e; font-weight:500;" >
            <a asp-action="Index" asp-controller="Admin" style="margin-right:1rem;">
    <i class="fas fa-home btn_previous"></i>
</a>
            Dodaj auto</h1>
        <div class="line" style="margin-bottom:2rem;"></div>
    </div>
}


<form asp-action="SaveCar" asp-controller="Admin" method="post" enctype="multipart/form-data" novalidate>
    <input type="hidden" asp-for="Car.Id" />
        <!-- Dane pojazdu -->
    <div class="form-section">
        <h3 class="title"><img src="~/icons/car_info.png" class="icon"/>Dane pojazdu</h3>
            <div class="row">
        <!-- Marka -->
        <div class="col-md-4">
    <div class="form-group">
        <label for="BrandId">Marka *</label>
        @Html.DropDownListFor(
                 model => model.Car.CarModel.BrandId,
                 new SelectList(Model.Brands, "Id", "Name"),
                 "Wybierz markę",
                 new { @class = "form-control", id = "BrandId", name = "Car.CarModel.BrandId" })
    </div>
    </div>

<!-- Model -->
    <div class="form-group col-md-4">
        <div>
                    <label for="CarModelId">Model *</label>
                    <button type="button" class="btn-success" data-bs-toggle="modal" data-bs-target="#addModelModal" id="addModelBtn" disabled>
            +
        </button>
        </div>
        @Html.DropDownListFor(
                 model => model.Car.CarModelId,
                 new SelectList(Model.CarModels, "Id", "Name"),
                 "Wybierz model",
                 new { @class = "form-control", id = "CarModelId", name = "Car.CarModelId", disabled = "disabled" })

        <input type="hidden" id="SelectedCarModelId" value="@Model.Car.CarModelId" />
    </div>

    <!-- Generacja -->
            <div class="col-md-4">
    <div class="form-group">
        <div>
                    <label for="VersionId">Generacja</label>
                    <button type="button" class="btn-success" data-bs-toggle="modal" data-bs-target="#addVersionModal" id="addVersionBtn" disabled>
            +
        </button>
        </div>
        @Html.DropDownListFor(
                 model => model.Car.VersionId,
                 new SelectList(Model.Versions, "Id", "Name"),
                 "Wybierz generację",
                 new { @class = "form-control", id = "VersionId", name = "Car.VersionId", disabled = "disabled" })
        <input type="hidden" id="SelectedCarVersionId" value="@Model.Car.VersionId" />
    </div>
    </div>
        <!-- VIN -->
        <div class="col-md-4">
    <div class="form-group">
        <label for="Car.VIN">VIN</label>
        <input asp-for="Car.VIN" class="form-control" />
        <span asp-validation-for="Car.VIN" class="text-danger"></span>
    </div>
        </div>
        </div>
        </div>

    <!-- Silnik i osiągi -->
    <div class="form-section">
        <h3 class="title"><img src="~/icons/engine.png" class="icon"/>Silnik i osiągi</h3>
        <div class="row">
            <!-- Pojemność skokowa/silnika -->
    <div class="form-group col-md-4">
        <label for="Car.CubicCapacity">Pojemność silnika (cm³) *</label>
        <input asp-for="Car.CubicCapacity" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.CubicCapacity == 0 ? "" : Model.Car.CubicCapacity.ToString())" />
        <span asp-validation-for="Car.CubicCapacity" class="text-danger"></span>
    </div>
    
    <!-- Moc silnika -->
    <div class="form-group col-md-4">
        <label for="Car.EnginePower">Moc silnika (KM) *</label>
        <input asp-for="Car.EnginePower" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.EnginePower == 0 ? "" : Model.Car.EnginePower.ToString())" />
        <span asp-validation-for="Car.EnginePower" class="text-danger"></span>
    </div>

        <!-- Skrzynia biegów -->
    <div class="form-group col-md-4">
        <label for="Gearbox">Rodzaj skrzyni biegów *</label>
        <select id="Gearbox" name="Car.Gearbox" class="form-control" asp-for="Car.Gearbox">
            @foreach (var gearbox in Model.Gearboxes)
            {
                <option value="@gearbox">@gearbox</option>
            }
        </select>
    </div>

        <!-- Napęd -->
    <div class="form-group col-md-4">
        <label for="Car.Drive">Napęd *</label>
        <select asp-for="Car.Drive" class="form-control">
            <option value="4x4">4x4</option>
            <option value="Na przód">Na przód</option>
            <option value="Na tył">Na tył</option>
        </select>
    </div>

        <!-- Paliwo -->
    <div class="form-group col-md-4">
        <label for="FuelType">Typ paliwa *</label>
        <select id="FuelType" name="Car.FuelType" class="form-control" asp-for="Car.FuelType">
            @foreach(var fuel in Model.FuelTypes)
            {
                <option value="@fuel">@fuel</option>
            }
        </select>
    </div>

        <!-- Przebieg -->
        <div class="col-md-4">
    <div class="form-group">
        <label for="Car.Mileage">Przebieg (km) *</label>
        <input asp-for="Car.Mileage" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.Mileage == 0 ? null : Model.Car.Mileage.ToString())" />
        <span asp-validation-for="Car.Mileage" class="text-danger"></span>
    </div>
    </div>
        </div>
        </div>

            <!-- Nadwozie i wymiary -->
            <div class="form-section">
                <h3 class="title"><img src="~/icons/car.png" class="icon" />Nadwozie i wymiary</h3>
                <div class="row">
            <!-- Typ nadwozia -->
    <div class="form-group col-md-4">
        <label for="BodyId">Typ nadwozia *</label>
        <select id="BodyId" name="Car.BodyId" class="form-control" asp-for="Car.BodyId">
            @foreach (var body in Model.BodyTypes)
            {
                <option value="@body.Id">@body.Name</option>
            }
        </select>
    </div>

        <!-- Kolor -->
    <div class="form-group col-md-4">
        <label for="Car.Color">Kolor *</label>
        <select asp-for="Car.Color" class="form-control">
            @foreach (var color in Model.Colors)
            {
                <option value="@color" selected="@(color == Model.SelectedColor ? "selected" : null)">
                    @color
                </option>
            }
        </select>
    </div>

    <!-- Typ lakieru -->
    <div class="form-group col-md-4">
        <label for="Car.ColorType">Typ lakieru *</label>
        <select asp-for="Car.ColorType" class="form-control">
            <option value="Błyszczący">Błyszczący</option>
            <option value="Chromowany">Chromowany</option>
            <option value="3D">3D</option>
            <option value="Matowy">Matowy</option>
            <option value="Matowy Perłowy">Matowy perłowy</option>
            <option value="Metalizowany">Metalizowany</option>
            <option value="Metalizowany Matowy">Metalizowany matowy</option>
            <option value="Perłowy">Perłowy</option>
        </select>
    </div>

        <!-- Drzwi -->
    <div class="form-group col-md-4">
        <label for="Car.Door">Liczba drzwi *</label>
        <input asp-for="Car.Door" type="number" class="form-control"
               oninput="this.value = this.value.replace(/[^0-9]/g, '')"
               value="@(Model.Car.Door == 0 ? "" : Model.Car.Door.ToString())" />
        <span asp-validation-for="Car.Door" class="text-danger"></span>
    </div>

    <!-- Miejsca -->
    <div class="form-group col-md-4">
        <label for="Car.Seat">Ilość miejsc *</label>
        <input asp-for="Car.Seat" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.Seat == 0 ? "" : Model.Car.Seat.ToString())" />
        <span asp-validation-for="Car.Seat" class="text-danger"></span>
    </div>

</div>
</div>

    <!-- Pochodzenie i właściciel -->
    <div class="form-section">
        <h3 class="title"><img src="~/icons/origin.png" class="icon" />Pochodzenie i właściciel</h3>
            <div class="row">
            <!-- Rok -->
    <div class="form-group col-md-4">
        <label for="Car.Year">Rok produkcji *</label>
        <input asp-for="Car.Year" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.Year == 0 ? null : Model.Car.Year.ToString())" />
        <span asp-validation-for="Car.Year" class="text-danger"></span>
    </div>

        <!-- Kraj pochodzenia -->
    <div class="form-group col-md-4">
        <label for="Car.Origin">Kraj pochodzenia *</label>
        <select asp-for="Car.Origin" class="form-control">
            @foreach (var country in Model.Countries)
            {
                <option value="@country">
                    @country
                </option>
            }
        </select>

    </div>

        <!-- Pierwszy właściciel -->
    <div class="form-group form-check">
        <input asp-for="Car.FirstOwner" class="form-check-input" type="checkbox" id="FirstOwner" />
        <label class="form-check-label" for="FirstOwner">Pierwszy właściciel</label>
    </div>

    <!-- Zarejstrowany w PL -->
    <div class="form-group form-check">
        <input asp-for="Car.PolishPlate" class="form-check-input" type="checkbox" id="PolishPlate" />
        <label class="form-check-label" for="PolishPlate">Zarejstrowany w PL</label>
    </div>

    <!-- Bezwypadkowy -->
    <div class="form-group form-check">
        <input asp-for="Car.AccidentFree" class="form-check-input" type="checkbox" id="AccidentFree" />
        <label class="form-check-label" for="AccidentFree">Bezwypadkowy</label>
    </div>
</div>
</div>


    <!-- Cena -->
        <div class="form-section">
            <div class="row">
                <div class="form-group col-md-4">
        <h3 class="title"><img src="~/icons/price.png" class="icon" /><label for="Car.OldPrice">Cena *</label></h3>
        <input asp-for="Car.OldPrice" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.OldPrice == 0 ? "" : Model.Car.OldPrice.ToString())" />
        <span asp-validation-for="Car.OldPrice" class="text-danger"></span>
    </div>
    </div>
    </div>
        <!-- Dodatkowe informacje -->
    <div class="form-section">
        <h3 class="title"><img src="~/icons/plus.png" class="icon" />Dodatkowe informacje</h3>
        <div class="row">
        <!-- Tytuł -->
    <div class="form-group col-md-4">
        <label for="Title">Tytuł *</label>
        <input asp-for="Car.Title" id="Title" name="Car.Title" type="text" class="form-control"/>
        <span asp-validation-for="Car.Title" class="text-danger"></span>
    </div>
    <!-- Opis -->
    <div class="form-group">
        <label for="description">Opis</label>
        <textarea asp-for="Car.Description" class="form-control" rows="6"></textarea>
    </div>
        </div>
        
        </div>
    <!-- Zdjęcia -->
        <div class="form-section">
                <div class="form-group">
        <h3 class="title"><img src="~/icons/photos.png" class="icon" /><label for="carPhotos">Zdjęcia samochodu</label></h3>
        <input type="file" name="carPhotos" id="carPhotos" class="form-control" multiple accept="image/*" />
        <small class="form-text text-muted">Możesz dodać jedno lub więcej zdjęć.</small>
        <span asp-validation-for="CarPhotos" class="text-danger"></span>
        @for (int i = 0; i < Model.SavedPhotoPaths.Count; i++)
        {
            <input type="hidden" name="SavedPhotoPaths[@i].Src" value="@Model.SavedPhotoPaths[i].Src" />
            <input type="hidden" name="SavedPhotoPaths[@i].IsMain" value="@Model.SavedPhotoPaths[i].IsMain.ToString().ToLower()" />
        }


    </div>

    <!-- Wybór głównego zdjęcia -->
    <div id="photoPreview" class="d-flex flex-wrap mt-3"></div>
    <input type="hidden" id="mainPhotoIndex" name="MainPhotoIndex" value="0" />
    </div>

<!-- Wyposażenie -->
        <div class="form-section">
            <div class="row">
                <div class="form-group">
        <h3 class="title"><img src="~/icons/equipment.png" class="icon" /><label>Wybierz wyposażenie</label></h3>
    <div class="col-md-4">    <input type="text" id="equipmentSearch" class="form-control mb-2" placeholder="Wpisz nazwę wyposażenia"></div>

    <table class="table">
        <thead>
            <tr>
                @foreach (var equipmentType in Model.EquipmentTypes)
                {
                    <th> <img src="@equipmentType.Icon" style="max-height:10px;"/>@equipmentType.Name</th>
                }
            </tr>
        </thead>
        <tbody>
            <tr>
                @foreach (var group in Model.GroupedEquipment)
                {
                    <td>
                        @foreach (var equipment in group.Equipments)
                        {
                            <div class="form-check equipment-item">
                                <input type="checkbox"
                                       class="form-check-input"
                                       id="equipment_@equipment.Id"
                                       name="SelectedEquipmentIds"
                                       value="@equipment.Id"
                                       @(Model.SelectedEquipmentIds.Contains(equipment.Id) ? "checked" : "")>
                                <label class="form-check-label" for="equipment_@equipment.Id">
                                    @equipment.Name
                                </label>
                            </div>
                        }
                    </td>
                }
            </tr>
        </tbody>
    </table>
</div>
</div>
</div>
    <button type="submit" class="btn_primary" style="margin-bottom:4rem;">
    @(Model.Car?.Id > 0 ? "Zapisz zmiany" : "Dodaj Auto")
</button>

</form>

<!-- Modal do dodawania nowego modelu -->
<div class="modal fade" id="addModelModal" tabindex="-1" aria-labelledby="addModelLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModelLabel">Dodaj nowy model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addModelForm">
                    <div class="form-group">
                        <label for="newModelName">Nazwa modelu</label>
                        <input type="text" id="newModelName" class="form-control" required>
                    </div>
                    <input type="hidden" id="selectedBrandId" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn_secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn_primary" onclick="addNewModel()">Dodaj</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal do dodawania nowej wersji -->
<div class="modal fade" id="addVersionModal" tabindex="-1" aria-labelledby="addVersionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVersionLabel">Dodaj nową generację</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addVersionForm">
                    <div class="form-group">
                        <label for="newVersionName">Nazwa generacji</label>
                        <input type="text" id="newVersionName" class="form-control" required>
                    </div>
                    <input type="hidden" id="selectedCarModelId" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn_secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn_primary" onclick="addNewVersion()">Dodaj</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    const searchInput = document.getElementById('equipmentSearch');
    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        const items = document.querySelectorAll('.equipment-item');

        items.forEach(item => {
            const label = item.querySelector('label').innerText.toLowerCase();
            if (label.includes(query)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
</script>
    <script>
         let rawPhotos = @Html.Raw(JsonConvert.SerializeObject(Model.SavedPhotoPaths ?? new List<TempPhoto>(), new JsonSerializerSettings {
    ContractResolver = new DefaultContractResolver()
}));

let form = document.querySelector("form");
let oldPhotos = [];

try {
    oldPhotos = typeof rawPhotos === "string" ? JSON.parse(rawPhotos) : rawPhotos;
} catch (e) {
    console.error("Błąd parsowania TempPhotos", e);
}

// === 📸 Render starych zdjęć (TempPhotos) ===
function renderExistingPhotos(photos) {
    const previewDiv = document.getElementById('photoPreview');
    previewDiv.innerHTML = "";

    photos.forEach((photo, index) => {
        const img = createImage(photo.Src);
        const radio = createRadio(index, photo.IsMain);
        const label = createLabelWithRadio(radio);
        const container = createContainer(img, label);

        appendHiddenInputs(photo, index);
        previewDiv.appendChild(container);
    });
}

function createImage(src) {
    const img = document.createElement('img');
    img.src = src;
    img.style.width = '100px';
    img.style.margin = '5px';
    return img;
}

function createRadio(index, isMain) {
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'mainPhoto';
    radio.value = index;
    if (isMain) {
        radio.checked = true;
        document.getElementById('mainPhotoIndex').value = index;
    }
    radio.addEventListener('change', function () {
        document.getElementById('mainPhotoIndex').value = this.value;
    });
    return radio;
}

function createLabelWithRadio(radio) {
    const label = document.createElement('label');
    label.textContent = 'Główne ';
    label.appendChild(radio);
    return label;
}

function createContainer(img, label) {
    const container = document.createElement('div');
    container.style.marginBottom = '10px';
    container.appendChild(img);
    container.appendChild(label);
    return container;
}

function appendHiddenInputs(photo, index) {
    const inputSrc = document.createElement("input");
    inputSrc.type = "hidden";
    inputSrc.name = `SavedPhotoPaths[${index}].Src`;
    inputSrc.value = photo.Src;

    const inputMain = document.createElement("input");
    inputMain.type = "hidden";
    inputMain.name = `SavedPhotoPaths[${index}].IsMain`;
    inputMain.value = photo.IsMain;

    form.appendChild(inputSrc);
    form.appendChild(inputMain);
}

if (Array.isArray(oldPhotos) && oldPhotos.length > 0) {
    renderExistingPhotos(oldPhotos);
}

// === 📤 Obsługa nowych zdjęć ===
document.getElementById("carPhotos").addEventListener("change", function () {
    const files = this.files;
    const previewDiv = document.getElementById('photoPreview');
    previewDiv.innerHTML = "";

    if (files.length > 0) {
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = createImage(e.target.result);
                const radio = createRadio(index, index === 0); // domyślnie pierwsze jako główne
                const label = createLabelWithRadio(radio);
                const container = createContainer(img, label);

                previewDiv.appendChild(container);
            };
            reader.readAsDataURL(file);
        });
    }
});

        $(document).ready(function () {
            let initialLoad = true;
            let selectedVersionId = '@Model.Car.VersionId';

            // Inicjalizacja danych po załadowaniu strony
            setTimeout(function () {
    let selectedBrandId = $('#BrandId').val();
    if (selectedBrandId) {
        // Teraz loadModelsForBrand sam wewnętrznie wywoła loadVersionsForModel
        loadModelsForBrand(selectedBrandId, true);
    }
}, 300);


            // Zdarzenie: zmiana marki
            $('#BrandId').change(function () {
                let brandId = $(this).val();
                $('#selectedBrandId').val(brandId);

                if (brandId) {
                    $('#CarModelId').prop('disabled', false);
                    $('#addModelBtn').prop('disabled', false);
                    $('#VersionId').prop('disabled', true).empty().append('<option value="" disabled selected>Wybierz generację</option>');
                    $('#addVersionBtn').prop('disabled', true);
                    loadModelsForBrand(brandId);
                } else {
                    $('#CarModelId, #VersionId').prop('disabled', true).empty();
                    $('#addModelBtn, #addVersionBtn').prop('disabled', true);
                }

                updateTitle();
            });

            // Zdarzenie: zmiana modelu
            $('#CarModelId').change(function () {
                let modelId = $(this).val();
                $('#SelectedCarModelId').val(modelId);

                if (modelId) {
                    loadVersionsForModel(modelId);
                } else {
                    $('#VersionId').empty().append('<option value="" disabled selected>Wybierz generację</option>').prop("disabled", true);
                    $('#addVersionBtn').prop("disabled", true);
                }

                updateTitle();
            });

            // Zdarzenie: zmiana generacji lub roku
            $("#VersionId, #Car_Year").on("change input", updateTitle);

            // Dodawanie nowego modelu
            window.addNewModel = function () {
                let modelName = $("#newModelName").val();
                let brandId = $("#BrandId").val();
                console.log(modelName, brandId)
if (!modelName) {
    alert("Podaj nazwę modelu!");
    return;
}
if (!brandId) {
    alert("Brakuje wybranej marki!");
    return;
}

                let formData = new FormData();
                formData.append("Name", modelName);
                formData.append("BrandId", brandId);

                $.ajax({
                    url: "/Admin/CreateModel",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        alert("Dodano pomyślnie!");
                        $('#addModelModal').modal('hide');

                        let modelSelect = $('#CarModelId');
                        modelSelect.append(`<option value="${response.id}" selected>${response.name}</option>`);
                        modelSelect.val(response.id).trigger('change');

                        $('#selectedCarModelId').val(response.id);
                        $('#CarModelId').prop('disabled', false);
                        $('#addModelBtn').prop('disabled', false);

                        $('#VersionId')
                            .empty()
                            .append('<option value="" disabled selected>Wybierz generację</option>')
                            .prop('disabled', false);

                        $('#addVersionBtn').prop('disabled', false);
                    },
                    error: function (xhr) {
                        if (xhr.status === 400) {
                            alert("Model już istnieje");
                        } else {
                            alert("Błąd dodawania modelu");
                        }
                    }
                });
            }

            // Dodawanie nowej generacji
            window.addNewVersion = function () {
                let versionName = $("#newVersionName").val();
                let modelId = $("#CarModelId").val();

                if (!versionName || !modelId) {
                    alert("Podaj nazwę generacji!");
                    return;
                }

                let formData = new FormData();
                formData.append("Name", versionName);
                formData.append("CarModelId", modelId);

                $.ajax({
                    url: "/Admin/CreateVersion",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        alert("Dodano pomyślnie!");
                        $('#addVersionModal').modal('hide');

                        let versionSelect = $('#VersionId');
                        versionSelect.append(`<option value="${response.id}" selected>${response.name}</option>`);
                        versionSelect.val(response.id).trigger('change');

                        $('#SelectedCarVersionId').val(response.id);
                        $('#VersionId').prop('disabled', false);
                        $('#addVersionBtn').prop('disabled', false);
                    },
                    error: function (xhr) {
                        if (xhr.status === 400) {
                            alert("Generacja już istnieje");
                        } else {
                            alert("Błąd dodawania generacji");
                        }
                    }
                });
            }

            // Aktualizacja tytułu auta
            function updateTitle() {
                clearTimeout(window.updateTitleTimeout);
                window.updateTitleTimeout = setTimeout(function () {
                    let brand = $("#BrandId").val() ? $("#BrandId option:selected").text() : "";
                    let model = $("#CarModelId").val() ? $("#CarModelId option:selected").text() : "";
                    let version = $("#VersionId").val() ? $("#VersionId option:selected").text() : "";
                    let year = $("#Car_Year").val() || "";

                    let title = [brand, model, version, year].filter(Boolean).join(" ");
                    $("#Title").val(title);
                }, 300);
            }

            // Pobieranie modeli dla danej marki
            async function loadModelsForBrand(brandId, selectPrevious = false) {
    try {
        let response = await $.ajax({
            url: '/Admin/GetCarModelsByBrand',
            data: { brandId: brandId },
            type: 'GET'
        });

        // Naturalne sortowanie modeli po nazwie
        response.sort((a, b) => a.name.localeCompare(b.name, 'pl', { numeric: true, sensitivity: 'base' }));

        let selectedModelId = selectPrevious ? $('#SelectedCarModelId').val() : null;
        let modelSelect = $('#CarModelId');
        modelSelect.empty().append('<option value="" disabled selected>Wybierz model</option>');

        $.each(response, function (index, item) {
            let selected = (item.id == selectedModelId) ? 'selected' : '';
            modelSelect.append(`<option value="${item.id}" ${selected}>${item.name}</option>`);
        });

        modelSelect.prop("disabled", false);
        $('#addModelBtn').prop("disabled", false);

        if (selectPrevious && selectedModelId) {
            setTimeout(() => {
                $('#CarModelId').val(selectedModelId).trigger('change');

                const selectedVersionId = $('#SelectedCarVersionId').val();
                if (selectedVersionId) {
                    loadVersionsForModel(selectedModelId, selectedVersionId);
                }
            }, 300);
        }

    } catch (error) {
        alert("Błąd podczas ładowania modeli.");
        console.error(error);
    }
}


            // Pobieranie generacji dla danego modelu
            async function loadVersionsForModel(modelId, selectedVersionId = null) {
                try {
                    let response = await $.ajax({
                        url: '@Url.Action("GetVersionsByModel", "Admin")',
                        data: { modelId: modelId },
                        type: 'GET'
                    });

                    let versionDropdown = $('#VersionId');
                    versionDropdown.empty();

                    versionDropdown.append($('<option>', {
                        value: '',
                        text: 'Wybierz generację',
                        disabled: true,
                        selected: !selectedVersionId
                    }));

                    response
    .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))
    .forEach(function (version) {
        versionDropdown.append($('<option>', {
            value: version.id,
            text: version.name,
            selected: selectedVersionId && version.id == selectedVersionId
        }));
    });


                    versionDropdown.prop('disabled', false);
                    $('#addVersionBtn').prop('disabled', false);
                } catch (error) {
                    alert("Błąd przy ładowaniu generacji.");
                    console.error(error);
                }
            }
        });
    </script>
}

