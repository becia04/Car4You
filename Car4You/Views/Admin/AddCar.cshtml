@model Car4You.ViewModels.CarViewModel


@{
    ViewData["Title"] = "Dodaj nowe auto";
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<h2>Dodaj nowe auto</h2>

<form asp-action="AddCar" method="post" enctype="multipart/form-data" novalidate>

    <!-- Marka -->
    <div class="form-group">
        <label for="BrandId">Marka</label>
        @Html.DropDownListFor(
                 model => model.Car.CarModel.BrandId,
                 new SelectList(Model.Brands, "Id", "Name"),
                 "Wybierz markę",
                 new { @class = "form-control", id = "BrandId", name = "Car.CarModel.BrandId" })
    </div>

    <!-- Model -->
    <div class="form-group">
        <label for="CarModelId">Model</label>
        @Html.DropDownListFor(
                 model => model.Car.CarModelId,
                 new SelectList(Model.CarModels, "Id", "Name"),
                 "Wybierz model",
                 new { @class = "form-control", id = "CarModelId", name = "Car.CarModelId", disabled = "disabled" })
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModelModal" id="addModelBtn" disabled>
            +
        </button>
        <input type="hidden" id="SelectedCarModelId" value="@Model.Car.CarModelId" />
    </div>

    <!-- Generacja -->
    <div class="form-group">
        <label for="VersionId">Generacja</label>
        @Html.DropDownListFor(
                 model => model.Car.VersionId,
                 new SelectList(Model.Versions, "Id", "Name"),
                 "Wybierz generację",
                 new { @class = "form-control", id = "VersionId", name = "Car.VersionId", disabled = "disabled" })
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addVersionModal" id="addVersionBtn" disabled>
            +
        </button>
        <input type="hidden" id="SelectedCarVersionId" value="@Model.Car.VersionId" />
    </div>

    <!-- Rok -->
    <div class="form-group">
        <label for="Car.Year">Rok produkcji *</label>
        <input asp-for="Car.Year" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.Year == 0 ? null : Model.Car.Year.ToString())" />
        <span asp-validation-for="Car.Year" class="text-danger"></span>
    </div>

    <!-- Tytuł -->
    <div class="form-group">
        <label for="Title">Tytuł *</label>
        <input asp-for="Car.Title" id="Title" name="Car.Title" type="text" class="form-control"/>
        <span asp-validation-for="Car.Title" class="text-danger"></span>
    </div>

    <!-- Przebieg -->
    <div class="form-group">
        <label for="Car.Mileage">Przebieg (km) *</label>
        <input asp-for="Car.Mileage" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.Mileage == 0 ? null : Model.Car.Mileage.ToString())" />
        <span asp-validation-for="Car.Mileage" class="text-danger"></span>
    </div>

    <!-- Paliwo -->
    <div class="form-group">
        <label for="FuelType">Typ paliwa *</label>
        <select id="FuelType" name="Car.FuelType" class="form-control" asp-for="Car.FuelType">
            @foreach(var fuel in Model.FuelTypes)
            {
                <option value="@fuel">@fuel</option>
            }
        </select>
    </div>

    <!-- Skrzynia biegów -->
    <div class="form-group">
        <label for="Gearbox">Rodzaj skrzyni biegów *</label>
        <select id="Gearbox" name="Car.Gearbox" class="form-control" asp-for="Car.Gearbox">
            @foreach (var gearbox in Model.Gearboxes)
            {
                <option value="@gearbox">@gearbox</option>
            }
        </select>
    </div>

    <!-- Typ nadwozia -->
    <div class="form-group">
        <label for="BodyId">Typ nadwozia *</label>
        <select id="BodyId" name="Car.BodyId" class="form-control" asp-for="Car.BodyId">
            @foreach (var body in Model.BodyTypes)
            {
                <option value="@body.Id">@body.Name</option>
            }
        </select>
    </div>

    <!-- Pojemność skokowa/silnika -->
    <div class="form-group">
        <label for="Car.CubicCapacity">Pojemność silnika (cm³) *</label>
        <input asp-for="Car.CubicCapacity" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.CubicCapacity == 0 ? "" : Model.Car.CubicCapacity.ToString())" />
        <span asp-validation-for="Car.CubicCapacity" class="text-danger"></span>
    </div>

    <!-- Moc silnika -->
    <div class="form-group">
        <label for="Car.EnginePower">Moc silnika (KM) *</label>
        <input asp-for="Car.EnginePower" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.EnginePower == 0 ? "" : Model.Car.EnginePower.ToString())" />
        <span asp-validation-for="Car.EnginePower" class="text-danger"></span>
    </div>

    <!-- Kolor -->
    <div class="form-group">
        <label for="Car.Color">Kolor *</label>
        <select asp-for="Car.Color" class="form-control">
            @foreach (var color in Model.Colors)
            {
                <option value="@color" selected="@(color == Model.SelectedColor ? "selected" : null)">
                    @color
                </option>
            }
        </select>
    </div>

    <!-- Typ lakieru -->
    <div class="form-group">
        <label for="Car.ColorType">Typ lakieru *</label>
        <select asp-for="Car.ColorType" class="form-control">
            <option value="Błyszczący">Błyszczący</option>
            <option value="Chromowany">Chromowany</option>
            <option value="3D">3D</option>
            <option value="Matowy">Matowy</option>
            <option value="Matowy Perłowy">Matowy perłowy</option>
            <option value="Metalizowany">Metalizowany</option>
            <option value="Metalizowany Matowy">Metalizowany matowy</option>
            <option value="Perłowy">Perłowy</option>
        </select>
    </div>

    <!-- Drzwi -->
    <div class="form-group">
        <label for="Car.Door">Liczba drzwi *</label>
        <input asp-for="Car.Door" type="number" class="form-control"
               oninput="this.value = this.value.replace(/[^0-9]/g, '')"
               value="@(Model.Car.Door == 0 ? "" : Model.Car.Door.ToString())" />
        <span asp-validation-for="Car.Door" class="text-danger"></span>
    </div>

    <!-- Miejsca -->
    <div class="form-group">
        <label for="Car.Seat">Ilość miejsc *</label>
        <input asp-for="Car.Seat" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.Seat == 0 ? "" : Model.Car.Seat.ToString())" />
        <span asp-validation-for="Car.Seat" class="text-danger"></span>
    </div>

    <!-- Napęd -->
    <div class="form-group">
        <label for="Car.Drive">Napęd *</label>
        <select asp-for="Car.Drive" class="form-control">
            <option value="4x4">4x4</option>
            <option value="Na przód">Na przód</option>
            <option value="Na tył">Na tył</option>
        </select>
    </div>

    <!-- Kraj pochodzenia -->
    <div class="form-group">
        <label for="Car.Origin">Kraj pochodzenia *</label>
        <select asp-for="Car.Origin" class="form-control">
            @foreach (var country in Model.Countries)
            {
                <option value="@country">
                    @country
                </option>
            }
        </select>

    </div>

    <!-- Pierwszy właściciel -->
    <div class="form-group form-check">
        <input asp-for="Car.FirstOwner" class="form-check-input" type="checkbox" id="FirstOwner" />
        <label class="form-check-label" for="FirstOwner">Pierwszy właściciel</label>
    </div>

    <!-- Cena -->
    <div class="form-group">
        <label for="Car.OldPrice">Cena *</label>
        <input asp-for="Car.OldPrice" type="number" class="form-control" oninput="this.value = this.value.replace(/[^0-9]/g, '')" value="@(Model.Car.OldPrice == 0 ? "" : Model.Car.OldPrice.ToString())" />
        <span asp-validation-for="Car.OldPrice" class="text-danger"></span>
    </div>

    <!-- VIN -->
    <div class="form-group">
        <label for="Car.VIN">VIN</label>
        <input asp-for="Car.VIN" class="form-control" />
        <span asp-validation-for="Car.VIN" class="text-danger"></span>
    </div>

    <!-- Opis -->
    <div class="form-group">
        <label for="description">Opis</label>
        <textarea asp-for="Car.Description" class="form-control" rows="6"></textarea>
    </div>

    <!-- Zdjęcia -->
    <div class="form-group">
        <label for="carPhotos">Zdjęcia samochodu</label>
        <input type="file" name="carPhotos" id="carPhotos" class="form-control" multiple accept="image/*" />
        <small class="form-text text-muted">Możesz dodać jedno lub więcej zdjęć.</small>
        <span asp-validation-for="CarPhotos" class="text-danger"></span>
    </div>

    <!-- Wybór głównego zdjęcia -->
    <div id="photoPreview" class="d-flex flex-wrap mt-3"></div>
    <input type="hidden" id="mainPhotoIndex" name="MainPhotoIndex" value="0" />

    <!-- Wyposażenie -->
    <div class="form-group">
        <label>Wybierz wyposażenie</label>
        <table class="table">
            <thead>
                <tr>
                    @foreach (var equipmentType in Model.EquipmentTypes)
                    {
                        <th>@equipmentType.Name</th>
                    }
                </tr>
            </thead>
            <tbody>
                <tr>
                    @foreach (var group in Model.GroupedEquipment)
                    {
                        <td>
                            @foreach (var equipment in group.Equipments)
                            {
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="equipment_@equipment.Id" name="SelectedEquipmentIds" value="@equipment.Id">
                                    <label class="form-check-label" for="equipment_@equipment.Id">
                                        @equipment.Name
                                    </label>
                                </div>
                            }
                        </td>
                    }
                </tr>
            </tbody>
        </table>
    </div>

   

    <button type="submit" class="btn btn-primary" style="margin-bottom:4rem;">Dodaj Auto</button>
</form>

<!-- Modal do dodawania nowego modelu -->
<div class="modal fade" id="addModelModal" tabindex="-1" aria-labelledby="addModelLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModelLabel">Dodaj nowy model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addModelForm">
                    <div class="form-group">
                        <label for="newModelName">Nazwa modelu</label>
                        <input type="text" id="newModelName" class="form-control" required>
                    </div>
                    <input type="hidden" id="selectedBrandId" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" onclick="addNewModel()">Dodaj</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal do dodawania nowej wersji -->
<div class="modal fade" id="addVersionModal" tabindex="-1" aria-labelledby="addVersionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVersionLabel">Dodaj nową generację</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addVersionForm">
                    <div class="form-group">
                        <label for="newVersionName">Nazwa generacji</label>
                        <input type="text" id="newVersionName" class="form-control" required>
                    </div>
                    <input type="hidden" id="selectedCarModelId" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" onclick="addNewVersion()">Dodaj</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(document).ready(function () {
            let initialLoad = true;
            let selectedVersionId = '@Model.Car.VersionId';

            // Inicjalizacja danych po załadowaniu strony
            setTimeout(function () {
                let selectedBrandId = $('#BrandId').val();
                if (selectedBrandId) {
                    loadModelsForBrand(selectedBrandId, true);
                }

                let selectedCarModelId = $('#CarModelId').val();
                if (selectedCarModelId) {
                    loadVersionsForModel(selectedCarModelId, initialLoad ? selectedVersionId : null);
                    initialLoad = false;
                }
            }, 300);

            // Zdarzenie: zmiana marki
            $('#BrandId').change(function () {
                let brandId = $(this).val();
                $('#selectedBrandId').val(brandId);

                if (brandId) {
                    $('#CarModelId').prop('disabled', false);
                    $('#addModelBtn').prop('disabled', false);
                    $('#VersionId').prop('disabled', true).empty().append('<option value="" disabled selected>Wybierz generację</option>');
                    $('#addVersionBtn').prop('disabled', true);
                    loadModelsForBrand(brandId);
                } else {
                    $('#CarModelId, #VersionId').prop('disabled', true).empty();
                    $('#addModelBtn, #addVersionBtn').prop('disabled', true);
                }

                updateTitle();
            });

            // Zdarzenie: zmiana modelu
            $('#CarModelId').change(function () {
                let modelId = $(this).val();
                $('#SelectedCarModelId').val(modelId);

                if (modelId) {
                    loadVersionsForModel(modelId);
                } else {
                    $('#VersionId').empty().append('<option value="" disabled selected>Wybierz generację</option>').prop("disabled", true);
                    $('#addVersionBtn').prop("disabled", true);
                }

                updateTitle();
            });

            // Zdarzenie: zmiana generacji lub roku
            $("#VersionId, #Car_Year").on("change input", updateTitle);

            // Obsługa podglądu zdjęć
            document.getElementById('carPhotos').addEventListener('change', function (event) {
                let previewDiv = document.getElementById('photoPreview');
                previewDiv.innerHTML = "";
                Array.from(event.target.files).forEach((file, index) => {
                    let img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.style.width = '100px';
                    img.style.margin = '5px';

                    let label = document.createElement('label');
                    label.innerHTML = `Główne <input type="radio" name="mainPhoto" value="${index}" ${index === 0 ? 'checked' : ''} />`;

                    let container = document.createElement('div');
                    container.appendChild(img);
                    container.appendChild(label);
                    previewDiv.appendChild(container);
                });

                document.querySelectorAll('input[name="mainPhoto"]').forEach(radio => {
                    radio.addEventListener('change', function () {
                        document.getElementById('mainPhotoIndex').value = this.value;
                    });
                });
            });

            // Dodawanie nowego modelu
            window.addNewModel = function () {
                let modelName = $("#newModelName").val();
                let brandId = $("#selectedBrandId").val();

                if (!modelName || !brandId) {
                    alert("Podaj nazwę modelu!");
                    return;
                }

                let formData = new FormData();
                formData.append("Name", modelName);
                formData.append("BrandId", brandId);

                $.ajax({
                    url: "/Admin/CreateModel",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        alert("Dodano pomyślnie!");
                        $('#addModelModal').modal('hide');

                        let modelSelect = $('#CarModelId');
                        modelSelect.append(`<option value="${response.id}" selected>${response.name}</option>`);
                        modelSelect.val(response.id).trigger('change');

                        $('#selectedCarModelId').val(response.id);
                        $('#CarModelId').prop('disabled', false);
                        $('#addModelBtn').prop('disabled', false);

                        $('#VersionId')
                            .empty()
                            .append('<option value="" disabled selected>Wybierz generację</option>')
                            .prop('disabled', false);

                        $('#addVersionBtn').prop('disabled', false);
                    },
                    error: function (xhr) {
                        if (xhr.status === 400) {
                            alert("Model już istnieje");
                        } else {
                            alert("Błąd dodawania modelu");
                        }
                    }
                });
            }

            // Dodawanie nowej generacji
            window.addNewVersion = function () {
                let versionName = $("#newVersionName").val();
                let modelId = $("#CarModelId").val();

                if (!versionName || !modelId) {
                    alert("Podaj nazwę generacji!");
                    return;
                }

                let formData = new FormData();
                formData.append("Name", versionName);
                formData.append("CarModelId", modelId);

                $.ajax({
                    url: "/Admin/CreateVersion",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        alert("Dodano pomyślnie!");
                        $('#addVersionModal').modal('hide');

                        let versionSelect = $('#VersionId');
                        versionSelect.append(`<option value="${response.id}" selected>${response.name}</option>`);
                        versionSelect.val(response.id).trigger('change');

                        $('#SelectedCarVersionId').val(response.id);
                        $('#VersionId').prop('disabled', false);
                        $('#addVersionBtn').prop('disabled', false);
                    },
                    error: function (xhr) {
                        if (xhr.status === 400) {
                            alert("Generacja już istnieje");
                        } else {
                            alert("Błąd dodawania generacji");
                        }
                    }
                });
            }

            // Aktualizacja tytułu auta
            function updateTitle() {
                clearTimeout(window.updateTitleTimeout);
                window.updateTitleTimeout = setTimeout(function () {
                    let brand = $("#BrandId").val() ? $("#BrandId option:selected").text() : "";
                    let model = $("#CarModelId").val() ? $("#CarModelId option:selected").text() : "";
                    let version = $("#VersionId").val() ? $("#VersionId option:selected").text() : "";
                    let year = $("#Car_Year").val() || "";

                    let title = [brand, model, version, year].filter(Boolean).join(" ");
                    $("#Title").val(title);
                }, 300);
            }

            // Pobieranie modeli dla danej marki
            async function loadModelsForBrand(brandId, selectPrevious = false) {
                try {
                    let response = await $.ajax({
                        url: '/Admin/GetCarModelsByBrand',
                        data: { brandId: brandId },
                        type: 'GET'
                    });

                    let selectedModelId = selectPrevious ? $('#SelectedCarModelId').val() : null;
                    let modelSelect = $('#CarModelId');
                    modelSelect.empty().append('<option value="" disabled selected>Wybierz model</option>');

                    $.each(response, function (index, item) {
                        let selected = (item.id == selectedModelId) ? 'selected' : '';
                        modelSelect.append(`<option value="${item.id}" ${selected}>${item.name}</option>`);
                    });

                    modelSelect.prop("disabled", false);
                    $('#addModelBtn').prop("disabled", false);

                    if (selectPrevious && selectedModelId) {
                        setTimeout(() => {
                            $('#CarModelId').val(selectedModelId).trigger('change');
                        }, 300);
                    }
                } catch (error) {
                    alert("Błąd podczas ładowania modeli.");
                    console.error(error);
                }
            }

            // Pobieranie generacji dla danego modelu
            async function loadVersionsForModel(modelId, selectedVersionId = null) {
                try {
                    let response = await $.ajax({
                        url: '@Url.Action("GetVersionsByModel", "Admin")',
                        data: { modelId: modelId },
                        type: 'GET'
                    });

                    let versionDropdown = $('#VersionId');
                    versionDropdown.empty();

                    versionDropdown.append($('<option>', {
                        value: '',
                        text: 'Wybierz generację',
                        disabled: true,
                        selected: !selectedVersionId
                    }));

                    response.forEach(function (version) {
                        versionDropdown.append($('<option>', {
                            value: version.id,
                            text: version.name,
                            selected: selectedVersionId && version.id == selectedVersionId
                        }));
                    });

                    versionDropdown.prop('disabled', false);
                    $('#addVersionBtn').prop('disabled', false);
                } catch (error) {
                    alert("Błąd przy ładowaniu generacji.");
                    console.error(error);
                }
            }
        });
    </script>
}

