@model List<Brand>

@{
    ViewData["Title"] = "Marki samochodowe";
}

<style>
    td.action-cell {
        width: 20%; /* węższa kolumna dla przycisku usuń */
    }

</style>
<link href="~/css/admin_site.css" rel="stylesheet" />

<div class="details-header" style="margin-top:180px;">
    <div style="flex: 0 0 75%;">
        <h1 style="margin:0; display:inline-block; color:#24435e; font-weight:500;">
            <a asp-action="Index" asp-controller="Admin" style="margin-right:1rem;">
                <i class="fas fa-arrow-left btn_previous"></i>
            </a>
            Zarządzaj markami
        </h1>
    </div>
    <div class="admin-btn">
        <!-- PRZYCISK OTWIERAJĄCY MODAL -->
        <button class="btn_primary" data-bs-toggle="modal" data-bs-target="#addBrandModal">
            <i class="fa fa-plus"></i> Dodaj
        </button>
    </div>
</div>
<div class="line"></div>
<table class="table">
    <thead>
        <tr>
            <th style="width:40%;">Nazwa</th>
            <th style="width:40%;">Logo</th>
            <th style="width:20%;"></th>
        </tr>
    </thead>
    <tbody id="brandTable">
        @foreach (var brand in Model)
        {
            <tr data-id="@brand.Id">
                <td style="width:40%;">
                    <a href="@Url.Action("ManageBrand", "Admin", new { id = brand.Id })" class="btn">
                        @brand.Name
                    </a>
                </td>

                <td style="width:40%;">
                    <img src="@brand.Icon" alt="@brand.Name" class="icon-preview"/>
                </td>
                <td class="action-cell">
                    <button class="btn_delete delete-btn">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- MODAL DODAWANIA MARKI -->
<div class="modal fade" id="addBrandModal" tabindex="-1" role="dialog" aria-labelledby="addBrandModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="border-radius: 16px;">
            <div class="modal-header" style="border-bottom: none;">
                <h5 class="modal-title" id="addBrandModalLabel" style="color:#24435e;">Dodaj nową markę</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>

            </div>
            <div class="modal-body">
                <form id="addBrandForm">
                    <div class="form-group">
                        <label for="newName">Nazwa</label>
                        <input type="text" id="newName" class="form-control" />
                        <div id="errorName" class="alert alert-danger d-none mt-2"></div>
                    </div>
                    <div class="form-group">
                        <label for="newImageFile">Logo</label>
                        <input type="file" id="newImageFile" class="form-control" />
                        <div id="errorIcon" class="alert alert-danger d-none mt-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: none;">
                <button type="button" class="btn_secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" id="saveBrandBtn" class="btn_primary">
                    <i class="fa fa-check"></i> Zapisz
                </button>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        var existingBrands = [];

        // Pobranie listy marek do tablicy
        $(".name-text").each(function () {
            existingBrands.push($(this).text().trim().toLowerCase());
        });

        // ✅ Kliknięcie przycisku Zapisz w modalu
        $("#saveBrandBtn").click(function () {
            var name = $("#newName").val().trim();
            var file = $("#newImageFile")[0].files[0];
            var state = 0;

            // Walidacja
            if (existingBrands.includes(name.toLowerCase())) {
                $("#errorName").text("Podana marka już istnieje").removeClass("d-none");
                state++;
            } else if (!name) {
                $("#errorName").text("Nazwa musi być podana").removeClass("d-none");
                state++;
            } else {
                $("#errorName").addClass("d-none");
            }

            if (!file) {
                $("#errorIcon").text("Wymagane logo").removeClass("d-none");
                state++;
            } else {
                $("#errorIcon").addClass("d-none");
            }

            if (state > 0) return;

            var formData = new FormData();
            formData.append("Name", name);
            formData.append("ImageFile", file);

            $.ajax({
                url: "/Admin/CreateBrand",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    // Dodanie wiersza do tabeli bez przeładowania
                    var newRow = `<tr data-id="${response.id}">
                                    <td>${name}</td>
                                    <td>
                                        <button class="btn btn-danger delete-btn"><i class="fa fa-trash"></i></button>
                                    </td>
                                  </tr>`;
                    $("#brandTable").append(newRow);
                    existingBrands.push(name.toLowerCase());
                    $("#addBrandModal").modal("hide");
                    alert("Marka dodana pomyślnie");
                    location.reload();
                },
                error: function (xhr) {
                    alert(xhr.responseText || "Błąd dodawania");
                }
            });
        });

        // ✅ Usuwanie marki
        $(".delete-btn").click(function () {
            var row = $(this).closest("tr");
            var id = row.data("id");

            if (confirm("Jesteś pewien, że chcesz usunąć?")) {
                $.ajax({
                    url: "/Admin/DeleteBrand/" + id,
                    type: "POST",
                    success: function () {
                        row.remove();
                        alert("Usunięto pomyślnie");
                    },
                    error: function (xhr) {
                        alert(xhr.responseText || "Błąd usuwania");
                    }
                });
            }
        });
    });
</script>
