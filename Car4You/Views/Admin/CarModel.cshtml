@model List<CarModel>

@{
    ViewData["Title"] = "Modele aut";
}

<!-- Dodanie Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<a asp-action="Index" asp-controller="Admin" class="btn btn-success">
    <i class="fa fa-arrow-left" aria-hidden="true">
    </i>
</a>
<h1>Zarządzaj modelami aut</h1>

<!-- Przycisk do rozwijania formularza -->
<button id="toggleAddFormBtn" class="btn btn-primary">
    <i class="fa fa-plus"></i> Dodaj
</button>

<!-- Ukryty formularz dodawania -->
<div id="addCarModelFormContainer" style="display: none; margin-top: 20px;">
    <form id="addCarModelForm">
        <div class="form-group">
            <label>Nazwa:</label>
            <input type="text" id="newName" class="form-control" />
            <div id="errorName" class="alert alert-danger d-none"></div>
        </div>
        <div class="form-group">
            <label>Marka:</label>
            <select id="newBrand" class="form-control">
                @foreach (var type in ViewBag.Brand)
                {
                    <option value="@type.Id">@type.Name</option>
                }
            </select>
            <div id="errorModel" class="alert alert-danger d-none"></div>
        </div>
        <button type="submit" class="btn btn-success">
            <i class="fa fa-check"></i> Add
        </button>
    </form>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Nazwa</th>
            <th>Marka</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="carModelTable">
        @foreach (var carModel in Model)
        {
            <tr data-id="@carModel.Id">
                <td>
                    <span class="name-text">@carModel.Name</span>
                    <input type="text" class="form-control name-input d-none" value="@carModel.Name" />
                    <div id="errorNameTable" class="alert alert-danger d-none"></div>
                </td>
                <td>
                    <span class="brand-text">@carModel.Brand.Name</span>
                    <select class="form-control brand d-none">
                        @foreach (var brand in ViewBag.Brand)
                        {
                            <option value="@brand.Id" selected="@(brand.Id == carModel.BrandId)">
                                @brand.Name
                            </option>
                        }
                    </select>
                    <div id="errorBrandTable" class="alert alert-danger d-none"></div>
                </td>
                <td>
                    <button class="btn btn-warning edit-btn">
                        <i class="fa fa-pencil-alt"></i>
                    </button>
                    <button class="btn btn-success save-btn d-none">
                        <i class="fa fa-save"></i>
                    </button>
                    <button class="btn btn-secondary cancel-btn d-none">
                        <i class="fa fa-times"></i>
                    </button>
                    <button class="btn btn-danger delete-btn">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var existingCarModels = [];
     $(document).ready(function () {
        // Pobranie listy marek do tablicy
        $(".name-text").each(function () {
            existingCarModels.push($(this).text().trim().toLowerCase());
        });

        // Pokazanie/ukrycie formularza
        $("#toggleAddFormBtn").click(function () {
            $("#addCarModelFormContainer").slideToggle();
        });

        // Edycja istniejącego rekordu
        $(".edit-btn").click(function () {
            var row = $(this).closest("tr");
            $(".cancel-btn").not(row.find(".cancel-btn")).click();

            row.find(".name-text, .brand-text").addClass("d-none");
            row.find(".name-input, .brand").removeClass("d-none");
            row.find(".edit-btn, .delete-btn").addClass("d-none");
            row.find(".save-btn, .cancel-btn").removeClass("d-none");
            });
        // Zapisanie zmian
        $(".save-btn").click(function () {
            var row = $(this).closest("tr");
            var id = row.data("id");
            var name = row.find(".name-input").val();
            var brandId = row.find(".brand").val();

            var formData = new FormData();
            formData.append("Id", id);
            formData.append("Name", name);
            formData.append("BrandId", brandId);
            var errorContainer = row.find("#errorNameTable");
            var state=0;
            if(!name){
                row.find("#errorNameTable").text("Nazwa jest wymagana").removeClass("d-none");
                state++;
            }
            // Sprawdzenie czy nazwa marki już istnieje (z wyjątkiem edytowanej)
        else if (existingCarModels.some((model, index) => model === name.toLowerCase() && row.data("id") != $(".name-text").eq(index).closest("tr").data("id"))) {
        errorContainer.text("Podany model już istnieje").removeClass("d-none");
                state++;
            }
            else{
                row.find("#errorNameTable").addClass("d-none");
            }
            if(state>0)
            {
                return;
            }
            $.ajax({
                url: "/Admin/EditModel",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    alert("Zaktualizowano pomyślnie");
                    location.reload();
                },
                error: function () {
                    alert("Błąd zmiany");
                }
            });
        });

        // Anulowanie edycji
            $(".cancel-btn").click(function () {
        var row = $(this).closest("tr");

        // Reset nazwy
        row.find(".name-input").val(row.find(".name-text").text());

        // Reset typu wyposażenia (ustawia select na oryginalny tekst)
        var originalBrand = row.find(".brand-text").text().trim();
        row.find(".brand option").each(function () {
            if ($(this).text().trim() === originalBrand) {
                $(this).prop("selected", true);
            }
        });

        // Przywrócenie UI do stanu początkowego
        row.find(".name-text, .brand-text").removeClass("d-none");
        row.find(".name-input, .brand").addClass("d-none");
        row.find(".edit-btn, .delete-btn").removeClass("d-none");
        row.find(".save-btn, .cancel-btn").addClass("d-none");
    row.find("#errorNameTable").addClass("d-none");
    });

        // Usuwanie elementu
            $(".delete-btn").click(function () {
        var row = $(this).closest("tr");
        var id = row.data("id");

        if (confirm("Jesteś pewien, że chcesz usunąć?")) {
            $.ajax({
                url: "/Admin/DeleteModel/" + id,
                type: "POST",
                success: function () {
                    row.remove();
                    alert("Pomyślnie usunięto");
                },
                error: function (xhr) {
                    alert(xhr.responseText || "Błąd usuwania");
                }
            });
        }
    });

        // Dodawanie nowego rekordu
    $("#addCarModelForm").submit(function (e) {
        e.preventDefault();

        var name = $("#newName").val();
        var brandId = $("#newBrand").val();

        //Walidacja danych
            var state=0;
            if (existingCarModels.includes(name.toLowerCase())) {
                $("#errorName").text("Podana marka już istnieje").removeClass("d-none");
                state++;
            }
            else if(!name){
                $("#errorName").text("Nazwa musi być podana").removeClass("d-none");
                state++;
            }
            else{
                $("#errorName").addClass("d-none");
            }
            if(!brandId)
            {
                $("#errorBrand").text("Wybierz markę").removeClass("d-none");
                state++;
            }
            else{
                $("#errorBrand").addClass("d-none");
            }
            if(state>0)
            {
                return;
            }

        var formData = new FormData();
        formData.append("Name", name);
        formData.append("BrandId", brandId);

        $.ajax({
            url: "/Admin/CreateModel",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("Dodano pomyślnie!");
                location.reload();
            },
            error: function (xhr) {
                console.error("Error:", xhr.responseText);
                alert("Error adding equipment. Check the console for details.");
            }
        });
    });
    });
</script>