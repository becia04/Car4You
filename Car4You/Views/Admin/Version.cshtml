
@model List<Car4You.Models.Version>

@{
    ViewData["Title"] = "Wersje aut";
}

<!-- Dodanie Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<a asp-action="Index" asp-controller="Admin" class="btn btn-success">
    <i class="fa fa-arrow-left" aria-hidden="true"></i>
</a>

<h1>Zarządzaj wersjami aut</h1>

<!-- Przycisk do rozwijania formularza -->
<button id="toggleAddFormBtn" class="btn btn-primary">
    <i class="fa fa-plus"></i> Dodaj
</button>

<!-- Ukryty formularz dodawania -->
<div id="addVersionFormContainer" style="display: none; margin-top: 20px;">
    <form id="addVersionForm">
        <div class="form-group">
            <label>Nazwa:</label>
            <input type="text" id="newName" class="form-control" />
            <div id="errorName" class="alert alert-danger d-none"></div>
        </div>
        <div class="form-group">
            <label>Marka:</label>
            <select id="newBrand" class="form-control">
                <option value="">Wybierz markę</option>
                @foreach (var brand in ViewBag.Brand)
                {
                    <option value="@brand.Id">@brand.Name</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label>Model:</label>
            <select id="newCarModel" class="form-control" disabled>
                <option value="">Wybierz model</option>
            </select>
            <div id="errorModel" class="alert alert-danger d-none"></div>
        </div>
        <button type="submit" class="btn btn-success">
            <i class="fa fa-check"></i> Dodaj
        </button>
    </form>
</div>

<!-- Filtrowanie tabeli -->
<div class="row mb-3">
    <!-- Pole wyszukiwania z przyciskiem "X" -->
    <div class="col-md-6 position-relative">
        <input type="text" id="searchInput" class="form-control" placeholder="Szukaj po nazwie...">
        <button id="clearSearch" class="btn btn-light position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); display: none;">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- Filtr marki z przyciskiem "X" -->
    <div class="col-md-6 position-relative">
        <select id="brandFilter" class="form-control">
            <option value="">Wybierz markę...</option>
            @foreach (var brand in ViewBag.Brand)
            {
                <option value="@brand.Name">@brand.Name</option>
            }
        </select>
        <button id="clearBrand" class="btn btn-light position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); display: none;">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- Filtr modelu z przyciskiem "X" -->
    <div class="col-md-6 position-relative">
        <select id="modelFilter" class="form-control">
            <option value="">Wybierz model...</option>
            @foreach (var carModel in ViewBag.CarModel)
            {
                <option value="@carModel.Name">@carModel.Name</option>
            }
        </select>
        <button id="clearModel" class="btn btn-light position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); display: none;">
            <i class="fa fa-times"></i>
        </button>
    </div>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Marka</th>
            <th>Model</th>
            <th>Nazwa</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="versionTable">
        @foreach (var version in Model)
        {
            <tr data-id="@version.Id">
                <td>
                    <span class="brand-text">@version.CarModel.Brand.Name</span>
                    <select class="form-control brand d-none">
                        @foreach (var brand in ViewBag.Brand)
                        {
                            <option value="@brand.Id" selected="@(brand.Id == version.CarModel.BrandId)">
                                @brand.Name
                            </option>
                        }
                    </select>
                    <div id="errorBrandTable" class="alert alert-danger d-none"></div>
                </td>
                <td>
                    <span class="carModel-text">@version.CarModel.Name</span>
                    <select class="form-control car-model d-none">
                        @foreach (var carModel in ViewBag.CarModel)
                        {
                            <option value="@carModel.Id" data-brand-id="@carModel.BrandId" selected="@(carModel.Id == version.CarModelId)">
                                @carModel.Name
                            </option>
                        }
                    </select>
                    <div id="errorCarModelTable" class="alert alert-danger d-none"></div>
                </td>
                <td>
                    <span class="name-text">@version.Name</span>
                    <input type="text" class="form-control name-input d-none" value="@version.Name" />
                    <div id="errorNameTable" class="alert alert-danger d-none"></div>
                </td>
                <td>
                    <button class="btn btn-warning edit-btn">
                        <i class="fa fa-pencil-alt"></i>
                    </button>
                    <button class="btn btn-success save-btn d-none">
                        <i class="fa fa-save"></i>
                    </button>
                    <button class="btn btn-secondary cancel-btn d-none">
                        <i class="fa fa-times"></i>
                    </button>
                    <button class="btn btn-danger delete-btn">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // 🔹 Filtrowanie tabeli
        function filterTable() {
            var searchText = $("#searchInput").val().toLowerCase();
            var selectedBrand = $("#brandFilter").val().toLowerCase();
            var selectedCarModel = $("#modelFilter").val().toLowerCase();

            $("#versionTable tr").each(function () {
                var name = $(this).find(".name-text").text().toLowerCase();
                var brand = $(this).find(".brand-text").text().toLowerCase();
                var model = $(this).find(".carModel-text").text().toLowerCase();

                var matchName = name.includes(searchText);
                var matchBrand = selectedBrand === "" || brand === selectedBrand;
                var matchModel = selectedCarModel === "" || model === selectedCarModel;

                $(this).toggle(matchName && matchBrand && matchModel);
            });

            // Pokaż/ukryj przyciski "X"
            $("#clearSearch").toggle(searchText.length > 0);
            $("#clearBrand").toggle(selectedBrand.length > 0);
            $("#clearModel").toggle(selectedCarModel.length > 0);
        }

        $("#searchInput, #brandFilter, #modelFilter").on("input change", filterTable);
        $("#clearSearch").click(function () { $("#searchInput").val(""); filterTable(); });
        $("#clearBrand").click(function () { $("#brandFilter").val(""); filterTable(); });
        $("#clearModel").click(function () { $("#modelFilter").val(""); filterTable(); });

        // 🔹 Lista istniejących wersji (do sprawdzenia duplikatów)
        var existingVersions = [];
        $(".name-text").each(function () {
            existingVersions.push($(this).text().trim().toLowerCase());
        });

        // 🔹 Pokazywanie formularza dodawania wersji
        $("#toggleAddFormBtn").click(function () {
            $("#addVersionFormContainer").slideToggle();
        });
        //Dynamiczne ładowanie modeli na podstawie marki
    function loadCarModels(brandSelect, carModelDropdown) {
        var brandId = brandSelect.val();

        if (brandId) {
            $.ajax({
                url: "/Admin/GetCarModelsByBrand",
                type: "GET",
                data: { brandId: brandId },
                success: function (data) {
                    carModelDropdown.empty(); // Usunięcie domyślnej opcji
                    data.forEach(function (model) {
                        carModelDropdown.append(`<option value="${model.id}">${model.name}</option>`);
                    });
                    carModelDropdown.prop("disabled", false);
                },
                error: function () {
                    alert("Błąd ładowania modeli aut.");
                }
            });
        } else {
            carModelDropdown.empty().prop("disabled", true);
        }
    }

    // Obsługa wyboru marki w formularzu dodawania
    $("#newBrand").change(function () {
        loadCarModels($(this), $("#newCarModel"));
    });

    // Obsługa wyboru marki w tabeli przy edycji
    $(document).on("change", ".brand", function () {
        var carModelDropdown = $(this).closest("tr").find(".car-model");
        loadCarModels($(this), carModelDropdown);
    });



        // 🔹 Dodawanie nowej wersji
        $("#addVersionForm").submit(function (e) {
            e.preventDefault();

            var name = $("#newName").val();
            var carModelId = $("#newCarModel").val();
            var state = 0;

            if (!name) {
                $("#errorName").text("Nazwa jest wymagana").removeClass("d-none");
                state++;
            } else {
                $("#errorName").addClass("d-none");
            }

            if (!carModelId) {
                $("#errorModel").text("Wybierz model").removeClass("d-none");
                state++;
            } else {
                $("#errorModel").addClass("d-none");
            }

            if (state > 0) return;

            var formData = new FormData();
            formData.append("Name", name);
            formData.append("CarModelId", carModelId);

            $.ajax({
                url: "/Admin/CreateVersion",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    alert("Dodano pomyślnie!");
                    location.reload();
                },
                error: function () {
                    alert("Błąd dodawania wersji.");
                }
            });
        });

        // 🔹 Edycja istniejącego rekordu
        $(".edit-btn").click(function () {
            var row = $(this).closest("tr");
            $(".cancel-btn").not(row.find(".cancel-btn")).click();

            row.find(".name-text, .brand-text, .carModel-text").addClass("d-none");
            row.find(".name-input, .brand, .car-model").removeClass("d-none");
            row.find(".edit-btn, .delete-btn").addClass("d-none");
            row.find(".save-btn, .cancel-btn").removeClass("d-none");
        });

        // 🔹 Zapisywanie zmian
        $(".save-btn").click(function () {
            var row = $(this).closest("tr");
            var id = row.data("id");
            var name = row.find(".name-input").val();
            var carModelId = row.find(".car-model").val();
            var errorContainer = row.find("#errorNameTable");
            var state = 0;

            if (!name) {
                errorContainer.text("Nazwa jest wymagana").removeClass("d-none");
                state++;
                } else if (existingVersions.some((model, index) =>
        model.name === name.toLowerCase() &&
        model.modelId === modelId &&
        row.data("id") != $(".name-text").eq(index).closest("tr").data("id")
    )) {
        errorContainer.text("Podana wersja dla tego modelu już istnieje").removeClass("d-none");
        state++;
            } else {
                errorContainer.addClass("d-none");
            }

            if (state > 0) return;

            var formData = new FormData();
            formData.append("Id", id);
            formData.append("Name", name);
            formData.append("CarModelId", carModelId);

            $.ajax({
                url: "/Admin/EditVersion",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    alert("Zaktualizowano pomyślnie");
                    location.reload();
                },
                error: function () {
                    alert("Błąd zmiany");
                }
            });
        });

        // 🔹 Anulowanie edycji
        $(".cancel-btn").click(function () {
            var row = $(this).closest("tr");

            row.find(".name-input").val(row.find(".name-text").text());

            var originalBrand = row.find(".brand-text").text().trim();
            row.find(".brand option").each(function () {
                if ($(this).text().trim() === originalBrand) {
                    $(this).prop("selected", true);
                }
            });

            var originalModel = row.find(".carModel-text").text().trim();
            row.find(".car-model option").each(function () {
                if ($(this).text().trim() === originalModel) {
                    $(this).prop("selected", true);
                }
            });

            row.find(".name-text, .brand-text, .carModel-text").removeClass("d-none");
            row.find(".name-input, .brand, .car-model").addClass("d-none");
            row.find(".edit-btn, .delete-btn").removeClass("d-none");
            row.find(".save-btn, .cancel-btn").addClass("d-none");
            row.find("#errorNameTable").addClass("d-none");
        });

        // 🔹 Usuwanie elementu
        $(".delete-btn").click(function () {
            var row = $(this).closest("tr");
            var id = row.data("id");

            if (confirm("Jesteś pewien, że chcesz usunąć?")) {
                $.ajax({
                    url: "/Admin/DeleteVersion/" + id,
                    type: "POST",
                    success: function () {
                        row.remove();
                        alert("Pomyślnie usunięto");
                    },
                    error: function (xhr) {
                        alert(xhr.responseText || "Błąd usuwania");
                    }
                });
            }
        });
    });
</script>

