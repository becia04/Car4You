@model List<Equipment>

@{
    ViewData["Title"] = "Wyposażeniem";
}

<!-- Dodanie Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<a asp-action="Index" asp-controller="Admin" class="btn btn-success">
    <i class="fa fa-arrow-left" aria-hidden="true">
    </i>
</a>
<h1>Zarządzaj wyposażeniem</h1>

<!-- Przycisk do rozwijania formularza -->
<button id="toggleAddFormBtn" class="btn btn-primary">
    <i class="fa fa-plus"></i> Dodaj
</button>

<!-- Ukryty formularz dodawania -->
<div id="addEquipmentFormContainer" style="display: none; margin-top: 20px;">
    <form id="addEquipmentForm">
        <div class="form-group">
            <label>Nazwa:</label>
            <input type="text" id="newName" class="form-control"/>
            <div id="errorName" class="alert alert-danger d-none"></div>
        </div>
        <div class="form-group">
            <label>Typ wyposażenia:</label>
            <select id="newEquipmentType" class="form-control">
                @foreach (var type in ViewBag.EquipmentTypes)
                {
                    <option value="@type.Id">@type.Name</option>
                }
            </select>
            <div id="errorType" class="alert alert-danger d-none"></div>
        </div>
        <div class="form-group">
            <label>Ikona:</label>
            <input type="file" id="newImageFile" class="form-control"/>
            <div id="errorIcon" class="alert alert-danger d-none"></div>
        </div>
        <button type="submit" class="btn btn-success">
            <i class="fa fa-check"></i> Add
        </button>
    </form>
</div>

<!-- Filtrowanie tabeli -->
<div class="row mb-3">
    <!-- Pole wyszukiwania z przyciskiem "X" -->
    <div class="col-md-6 position-relative">
        <input type="text" id="searchInput" class="form-control" placeholder="Szukaj po nazwie...">
        <button id="clearSearch" class="btn btn-light position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); display: none;">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- Filtr marki z przyciskiem "X" -->
    <div class="col-md-6 position-relative">
        <select id="typeFilter" class="form-control">
            <option value="">Wybierz typ...</option>
            @foreach (var type in ViewBag.EquipmentTypes)
            {
                <option value="@type.Name">@type.Name</option>
            }
        </select>
        <button id="clearType" class="btn btn-light position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); display: none;">
            <i class="fa fa-times"></i>
        </button>
    </div>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Nazwa</th>
            <th>Ikona</th>
            <th>Typ</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="equipmentTable">
        @foreach (var equipment in Model)
        {
            <tr data-id="@equipment.Id">
                <td>
                    <span class="name-text">@equipment.Name</span>
                    <input type="text" class="form-control name-input d-none" value="@equipment.Name" />
                    <div id="errorNameTable" class="alert alert-danger d-none"></div>
                </td>
                <td>
                    <img src="@equipment.Icon" alt="@equipment.Name" class="icon-preview" style="width: 50px; height: 50px;" />
                    <input type="file" class="form-control image-input d-none" />
                    <div id="errorIconTable" class="alert alert-danger d-none"></div>
                </td>
                <td>
                    <span class="type-text">@equipment.EquipmentType.Name</span>
                    <select class="form-control equipment-type d-none">
                        @foreach (var type in ViewBag.EquipmentTypes)
                        {
                            <option value="@type.Id" selected="@(type.Id == equipment.EquipmentTypeId)">
                                @type.Name
                            </option>
                        }
                    </select>
                    <div id="errorTypeTable" class="alert alert-danger d-none"></div>
                </td>
                <td>
                    <button class="btn btn-warning edit-btn">
                        <i class="fa fa-pencil-alt"></i>
                    </button>
                    <button class="btn btn-success save-btn d-none">
                        <i class="fa fa-save"></i>
                    </button>
                    <button class="btn btn-secondary cancel-btn d-none">
                        <i class="fa fa-times"></i>
                    </button>
                    <button class="btn btn-danger delete-btn">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    //Filtrowanie tabeli
            $(document).ready(function () {
        function filterTable() {
            var searchText = $("#searchInput").val().toLowerCase();
            var selectedType = $("#typeFilter").val().toLowerCase();

            $("#equipmentTable tr").each(function () {
                var name = $(this).find(".name-text").text().toLowerCase();
                var type = $(this).find(".type-text").text().toLowerCase();

                var matchName = name.includes(searchText);
                var matchType = selectedType === "" || type === selectedType;

                $(this).toggle(matchName && matchType);
            });

            // Pokaż/ukryj przyciski "X"
            $("#clearSearch").toggle(searchText.length > 0);
            $("#clearType").toggle(selectedType.length > 0);
        }

        // Obsługa filtrowania po wpisaniu tekstu lub zmianie marki
        $("#searchInput, #typeFilter").on("input change", filterTable);

        // Obsługa czyszczenia pola wyszukiwania
        $("#clearSearch").click(function () {
            $("#searchInput").val("");
            filterTable();
        });

        // Obsługa resetowania filtra marki
        $("#clearType").click(function () {
            $("#typeFilter").val("");
            filterTable();
        });
    });

    var existingEquipments = [];
     $(document).ready(function () {
        // Pobranie listy marek do tablicy
        $(".name-text").each(function () {
            existingEquipments.push($(this).text().trim().toLowerCase());
        });

        // Pokazanie/ukrycie formularza
        $("#toggleAddFormBtn").click(function () {
            $("#addEquipmentFormContainer").slideToggle();
        });

        // Edycja istniejącego rekordu
        $(".edit-btn").click(function () {
            var row = $(this).closest("tr");
            $(".cancel-btn").not(row.find(".cancel-btn")).click();

            row.find(".name-text, .type-text").addClass("d-none");
            row.find(".name-input, .equipment-type, .image-input").removeClass("d-none");
            row.find(".edit-btn, .delete-btn").addClass("d-none");
            row.find(".save-btn, .cancel-btn").removeClass("d-none");
            });
        // Zapisanie zmian
        $(".save-btn").click(function () {
            var row = $(this).closest("tr");
            var id = row.data("id");
            var name = row.find(".name-input").val();
            var typeId = row.find(".equipment-type").val();
            var file = row.find(".image-input")[0].files[0];

            var formData = new FormData();
            formData.append("Id", id);
            formData.append("Name", name);
            formData.append("EquipmentTypeId", typeId);
            var errorContainer = row.find("#errorNameTable");
            var state=0;
            if(!name){
                errorContainer.text("Nazwa jest wymagana").removeClass("d-none");
                state++;
            }
            // Sprawdzenie czy nazwa marki już istnieje (z wyjątkiem edytowanej)
        else if (existingEquipments.some((model, index) => model === name.toLowerCase() && row.data("id") != $(".name-text").eq(index).closest("tr").data("id"))) {
        errorContainer.text("Podane wyposażenie już istnieje").removeClass("d-none");
                state++;
            }
            else{
                errorContainer.addClass("d-none");
            }
            if(state>0)
            {
                return;
            }
            if (file) {
                formData.append("ImageFile", file);
            }
            $.ajax({
                url: "/Admin/EditEquipment",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    alert("Zaktualizowano pomyślnie");
                    location.reload();
                },
                error: function () {
                    alert("Błąd zmiany");
                }
            });
        });

        // Anulowanie edycji
            $(".cancel-btn").click(function () {
        var row = $(this).closest("tr");

        // Powrót do oryginalnych wartości
        row.find(".name-input").val(row.find(".name-text").text());
        row.find(".image-input").val("");
        var originalType = row.find(".type-text").text().trim();
        row.find(".equipment-type option").each(function () {
            if ($(this).text().trim() === originalType) {
                $(this).prop("selected", true);
            }
        });
        var errorContainer = row.find("#errorNameTable");
        // Przywrócenie UI do stanu początkowego
        row.find(".name-text, .type-text").removeClass("d-none");
        row.find(".name-input, .equipment-type, .image-input").addClass("d-none");
        row.find(".edit-btn, .delete-btn").removeClass("d-none");
        row.find(".save-btn, .cancel-btn").addClass("d-none");
        errorContainer.addClass("d-none");
    });

        // Usuwanie elementu
            $(".delete-btn").click(function () {
        var row = $(this).closest("tr");
        var id = row.data("id");

        if (confirm("Jesteś pewien, że chcesz usunąć?")) {
            $.ajax({
                url: "/Admin/DeleteEquipment/" + id,
                type: "POST",
                success: function () {
                    row.remove();
                    alert("Pomyślnie usunięto");
                },
                error: function (xhr) {
                    alert(xhr.responseText || "Błąd usuwania");
                }
            });
        }
    });

        // Dodawanie nowego rekordu
    $("#addEquipmentForm").submit(function (e) {
        e.preventDefault();

        var name = $("#newName").val();
        var typeId = $("#newEquipmentType").val();
        var file = $("#newImageFile")[0].files[0];

        //Walidacja danych
            var state=0;
            if (existingEquipments.includes(name.toLowerCase())) {
                $("#errorName").text("Podane wyposażenie już istnieje").removeClass("d-none");
                state++;
            }
            else if(!name){
                $("#errorName").text("Nazwa musi być podana").removeClass("d-none");
                state++;
            }
            else{
                $("#errorName").addClass("d-none");
            }
            if(!file){
                $("#errorIcon").text("Wymagana ikona").removeClass("d-none");
                state++;
            }
            else{
                $("#errorIcon").addClass("d-none");
            }
            if(!typeId)
            {
                $("#errorType").text("Wybierz typ").removeClass("d-none");
                state++;
            }
            else{
                $("#errorType").addClass("d-none");
            }
            if(state>0)
            {
                return;
            }

        var formData = new FormData();
        formData.append("Name", name);
        formData.append("EquipmentTypeId", typeId);
        formData.append("ImageFile", file);

        $.ajax({
            url: "/Admin/CreateEquipment",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("Pomyślnie dodano!");
                location.reload();
            },
            error: function (xhr) {
                console.error("Error:", xhr.responseText);
                alert("Error adding equipment. Check the console for details.");
            }
        });
    });
    });
</script>