@model Brand
<link href="~/css/admin_site.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    .btn-group-cell .btn_primary,
    .btn-group-cell .btn_delete {
        min-width:50px;
    }
    /* Kontener wersji — ustawienie tekstu i przycisków w jednej linii */
    td ul li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid #ccc;

    }

    /* Nazwa wersji z elastycznym miejscem */
    .version-text {
        flex: 1;
        text-align: center;
        margin-right: 1px;
        white-space: nowrap;
        overflow: hidden;
    }



</style>

<label class="id-label" data-id="@Model.Id" style="visibility:hidden;">@Model.Id</label>
<div class="details-header">
    <div style="flex: 0 0 75%;">
        <h1 style="margin-right:1rem; display:inline-block; color:#24435e; font-weight:500;">
            <a asp-action="Brand" asp-controller="Admin">
                <i class="fas fa-arrow-left btn_previous"></i>
            </a>
        </h1>
        <img src="@Model.Icon" style="height:40px; width:auto; margin-right:1rem; margin-bottom:1rem;" />
        <h1 style="margin:0; display:inline-block; color:#24435e; font-weight:500;">
            Zarządzaj marką - <label class="name-text" data-id="@Model.Id" style="margin:0; display:inline-block; color:#24435e; font-weight:500;">@Model.Name</label>
        </h1>
        
    </div>
    <div class="admin-btn">
        <!-- Przycisk wywołujący modal -->
        <button class="btn_primary edit-brand-btn" data-bs-toggle="modal" data-bs-target="#editBrandModal">
            <i class="far fa-edit"></i> Edytuj
        </button>
    </div>
</div>
<div class="line"></div>


<table class="table">
    <thead>
        <tr>
            <th style="width:35%">
                Model
            </th>
            <th style="width:20%;">
                    <button class="btn_primary" data-bs-toggle="modal" data-bs-target="#addModelModal">
                        <i class="fa fa-plus"></i> Dodaj
                    </button>
            </th>
            <th style="width:35%;">Wersja</th>
            <th style="width:10%"></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var carModel in Model.CarModels)
        {
            <tr data-id="@carModel.Id">
                <td style="width:35%;">
                    <label class="carModel-id" data-id="@carModel.Id" style="visibility:hidden;">@Model.Id</label>
                    <span class="carModel-text">@carModel.Name</span>
                    
                </td>
                <td class="action-cell" style="width:20%">
                    <div class="btn-group-cell">
                    <button class="btn_primary edit-carModel-btn">
                            <i class="far fa-edit"></i>
                    </button>
                    <button class="btn_delete delete-carModel-btn">
                        <i class="fa fa-trash"></i>
                    </button>
                    </div>
</td>
                <!-- Kolumna Wersja -->
                <td style="width:35%;">
                    <ul class="list-unstyled">
                        @foreach (var version in carModel.Versions)
                        {
                            <li data-version-id="@version.Id">
                                <label class="version-id" data-id="@version.Id" style="visibility:hidden;">@version.Id</label>
                                <span class="version-text">@version.Name</span>
                                <div class="btn-group-cell" style="flex-shrink:0; display: flex; gap: 6px;">
                                    <button class="btn_primary edit-version-btn">
                                        <i class="far fa-edit"></i>
                                    </button>
                                    <button class="btn_delete delete-version-btn">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </li>
                        }
                    </ul>
                    
                </td>
                <!-- Przycisk do dodawania nowej wersji -->
                <td class="action-cell" style="width:10%;">
                    <div class="btn-group-cell">
                        <button class="btn_primary add-version-btn">
                            <i class="fa fa-plus"></i>
                        </button>
                        
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Modal dla marki-->
<div class="modal fade" id="editBrandModal" tabindex="-1" aria-labelledby="editBrandModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBrandModalLabel">Edytuj markę - @Model.Name</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nazwa marki</label>
                    <input type="text" name="name" value="@Model.Name" class="form-control name-input" placeholder="Nowa nazwa marki" />
                </div>
                <div class="mb-3 d-flex align-items-center gap-3">
                    <img src="@Model.Icon" alt="Podgląd" class="icon-preview" style="height:40px; width:auto;" />
                    <input type="file" class="form-control icon-input" accept="image/*" />
                </div>
                <div id="errorName" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-brand-btn" data-bs-dismiss="modal"><i class="fa fa-times"></i> Anuluj</button>
                <button type="button" class="btn btn-success save-brand-btn"><i class="fa fa-save"></i> Zapisz</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dodaj Nowy Model -->
<div class="modal fade" id="addModelModal" tabindex="-1" aria-labelledby="addModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModelModalLabel">Dodaj nowy model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newModelName" class="form-label">Nazwa modelu</label>
                    <input type="text" class="form-control" id="newModelName" placeholder="Wpisz nazwę modelu" />
                    <div id="errorNewModelModal" class="alert alert-danger d-none mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn_secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn_primary" id="saveNewModelModalBtn"><i class="fa fa-save"></i> Dodaj</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edycja Modelu -->
<div class="modal fade" id="editModelModal" tabindex="-1" aria-labelledby="editModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModelModalLabel">Edytuj model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="editModelName" class="form-label">Nazwa modelu</label>
                    <input type="text" class="form-control" id="editModelName" placeholder="Wpisz nową nazwę" />
                    <div id="errorEditModelModal" class="alert alert-danger d-none mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn_secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn_primary" id="saveEditModelModalBtn"><i class="fa fa-save"></i> Zapisz</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal edycji wersji -->
<div class="modal fade" id="editVersionModal" tabindex="-1" aria-labelledby="editVersionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editVersionModalLabel">Edytuj generację</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editVersionId" />
                <div class="mb-3">
                    <label for="editVersionName" class="form-label">Nazwa wersji</label>
                    <input type="text" id="editVersionName" class="form-control" />
                    <div id="errorEditVersion" class="alert alert-danger d-none mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn_secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" id="saveVersionChanges" class="btn_primary">Zapisz zmiany</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal dodawania nowej wersji -->
<div class="modal fade" id="addVersionModal" tabindex="-1" aria-labelledby="addVersionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVersionModalLabel">Dodaj nową wersję</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="addVersionModelId" />
                <div class="mb-3">
                    <label for="addVersionName" class="form-label">Nazwa wersji</label>
                    <input type="text" id="addVersionName" class="form-control" />
                    <div id="errorAddVersion" class="alert alert-danger d-none mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn_secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" id="saveNewVersion" class="btn_primary">Dodaj</button>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script>
                 // 🔹 Podgląd nowej ikony
        $(".icon-input").on("change", function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (ev) {
                    $(".icon-preview").attr("src", ev.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // ✅ Zapisz zmianę marki (nazwa + ikona)
        $(".save-brand-btn").click(async function () {
            const id = $(".name-input").closest(".modal-content").find(".name-input").data("id") || @Model.Id;
            const name = $(".name-input").val().trim();
            const file = $(".icon-input")[0].files[0];
            const oldName = "@Model.Name";

            // Walidacja
            if (!name) {
                $("#errorName").text("Nazwa jest wymagana").removeClass("d-none");
                return;
            }

            if (name === oldName && !file) {
                $("#editBrandModal").modal('hide');
                return;
            }

            // 🔹 walidacja duplikatu tylko jeśli zmieniono nazwę
            if (name.toLowerCase() !== oldName.toLowerCase()) {
                let existingBrands = [];
                try {
                    const response = await fetch("/Admin/GetBrands");
                    const data = await response.json();
                    existingBrands = data.map(b => b.name.toLowerCase().trim());
                } catch (err) {
                    console.log("Błąd pobierania marek:", err);
                }

                if (existingBrands.includes(name.toLowerCase())) {
                    $("#errorName").text("Podana marka już istnieje").removeClass("d-none");
                    return;
                } else {
                    $("#errorName").addClass("d-none");
                }
            } else {
                $("#errorName").addClass("d-none");
            }

            const formData = new FormData();
            formData.append("Id", id);
            formData.append("Name", name);
            if (file) formData.append("ImageFile", file);

            $.ajax({
                url: "/Admin/EditBrandFull",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    alert("Zaktualizowano pomyślnie");
                    location.reload();
                },
                error: function () {
                    alert("Błąd aktualizacji");
                }
            });
        });

        // Dodawanie nowego modelu do bazy
        // Otwieranie modala z przypisaniem brandId
        let currentBrandId = $(".id-label").data("id"); // zakładamy, że id marki jest w elemencie .id-label

        // Zapis nowego modelu z modala
        $("#saveNewModelModalBtn").click(function () {
            const name = $("#newModelName").val().trim();
            const brandId = currentBrandId;

            // Pobranie istniejących modeli w tabeli
            const existingCarModels = $(".carModel-text").map(function() {
                return $(this).text().trim().toLowerCase();
            }).get();

            let state = 0;
            if (!name) {
                $("#errorNewModelModal").text("Nazwa musi być podana").removeClass("d-none");
                state++;
            } else if (existingCarModels.includes(name.toLowerCase())) {
                $("#errorNewModelModal").text("Podany model już istnieje").removeClass("d-none");
                state++;
            } else {
                $("#errorNewModelModal").addClass("d-none");
            }

            if (state > 0) return;

            // Wysyłamy do serwera
            const formData = new FormData();
            formData.append("Name", name);
            formData.append("BrandId", brandId);

            $.ajax({
                url: "/Admin/CreateModel",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    alert("Dodano pomyślnie!");
                    location.reload(); // lub dynamiczne dodanie wiersza do tabeli
                },
                error: function (xhr) {
                    console.error("Błąd:", xhr.responseText);
                    alert("Wystąpił błąd. Sprawdź konsolę.");
                }
            });
        });

        // Edycja modelu - otwieranie modala z aktualną nazwą
        let editModelId = null;
        $(".edit-carModel-btn").click(function () {
            const row = $(this).closest("tr");
            editModelId = row.data("id");
            const currentName = row.find(".carModel-text").text().trim();

            // Wstawiamy aktualną nazwę do inputa w modalu
            $("#editModelName").val(currentName);
            $("#errorEditModelModal").addClass("d-none");

            // Otwieramy modal
            const editModal = new bootstrap.Modal(document.getElementById('editModelModal'));
            editModal.show();
        });
            //Edycja modelu - zapis zmian
           $("#saveEditModelModalBtn").click(function () {
            const name = $("#editModelName").val().trim();

            // Pobranie wszystkich modeli w tabeli do walidacji
            const existingCarModels = $(".carModel-text").map(function() {
                return $(this).text().trim().toLowerCase();
            }).get();

            let state = 0;
            if (!name) {
                $("#errorEditModelModal").text("Nazwa jest wymagana").removeClass("d-none");
                state++;
            } else if (existingCarModels.some((model, index) => model === name.toLowerCase() && editModelId != $(".carModel-text").eq(index).closest("tr").data("id"))) {
                $("#errorEditModelModal").text("Podany model już istnieje").removeClass("d-none");
                state++;
            } else {
                $("#errorEditModelModal").addClass("d-none");
            }

            if (state > 0) return;

            // AJAX do backendu
            const formData = new FormData();
            formData.append("Id", editModelId);
            formData.append("Name", name);

            $.ajax({
                url: "/Admin/EditModel",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    alert("Zaktualizowano pomyślnie!");
                    location.reload();
                },
                error: function () {
                    alert("Błąd aktualizacji modelu");
                }
            });
        });


           //Usuwanie modelu
           $(".delete-carModel-btn").click(function () {
               var row = $(this).closest("tr");
               var id = row.data("id");

               if (!confirm("Jesteś pewien, że chcesz usunąć ten model?")) {
                   return;
               }

               $.ajax({
                   url: "/Admin/DeleteModel/" + id,
                   type: "POST",
                   success: function (response) {
                       if (!response.success) {
                           // Jeśli model ma powiązane wersje, wyświetl pytanie
                           if (response.versions) {
                               var versionsList = response.versions.join(", ");
        var confirmDeleteVersions = confirm(
            `Model ma powiązane wersje: ${versionsList}.\nCzy chcesz je również usunąć?`
        );

                               if (confirmDeleteVersions) {
                                   deleteModelWithVersions(id);
                               }
                           } else {
                               alert(response.message);
                           }
                       } else {
                           row.remove();
                           alert("Pomyślnie usunięto model.");
                       }
                   },
                   error: function (xhr) {
                       alert(xhr.responseText || "Błąd usuwania");
                   }
               });
           });

           // Funkcja do usuwania modelu wraz z wersjami
           function deleteModelWithVersions(id) {
               $.ajax({
                   url: "/Admin/DeleteModelWithVersions",
                   type: "POST",
                   data: { id: id },
                   success: function () {
                       alert("Model i jego wersje zostały usunięte.");
                       location.reload();
                   },
                   error: function () {
                       alert("Błąd usuwania modelu i wersji.");
                   }
               });
           }


                  // Edycja generacji - otwieranie modala z aktualną nazwą
        $(document).on("click", ".edit-version-btn", function () {
            var versionRow = $(this).closest("li");
            var versionId = versionRow.data("version-id");
            var versionName = versionRow.find(".version-text").text().trim();

            // Wypełniamy pola modala
            $("#editVersionId").val(versionId);
            $("#editVersionName").val(versionName);
            $("#errorEditVersion").addClass("d-none").text("");

            // Pokazujemy modal
            var modal = new bootstrap.Modal(document.getElementById("editVersionModal"));
            modal.show();
        });

        // Edycja generacji - zapis zmian
        $("#saveVersionChanges").click(function () {
            var id = $("#editVersionId").val();
            var name = $("#editVersionName").val().trim();

            // Pobranie aktualnego modelu (tr, który zawiera tę wersję)
            var modelRow = $("li[data-version-id='" + id + "']").closest("tr");
            var modelId = modelRow.data("id");

            // Walidacja
            var existingVersions = modelRow.find(".version-text").map(function () {
                return $(this).text().trim().toLowerCase();
            }).get();

            if (!name) {
                $("#errorEditVersion").removeClass("d-none").text("Nazwa jest wymagana");
                return;
            }

            if (existingVersions.includes(name.toLowerCase()) &&
                name.toLowerCase() !== $("li[data-version-id='" + id + "'] .version-text").text().trim().toLowerCase()) {
                $("#errorEditVersion").removeClass("d-none").text("Taka wersja już istnieje w tym modelu");
                return;
            }

            // Wysyłamy dane
            var formData = new FormData();
            formData.append("Id", id);
            formData.append("Name", name);

            $.ajax({
                url: "/Admin/EditVersion",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    $("#editVersionModal").modal("hide");
                    alert("Zaktualizowano pomyślnie!");
                    location.reload();
                },
                error: function () {
                    $("#errorEditVersion").removeClass("d-none").text("Błąd aktualizacji.");
                }
            });
        });

           // 🔹 Usuwanie wersji
               $(".delete-version-btn").click(function () {
                   var row = $(this).closest("li");
                   var id = row.data("version-id");

                   if (confirm("Jesteś pewien, że chcesz usunąć?")) {
                       $.ajax({
                           url: "/Admin/DeleteVersion/" + id,
                           type: "POST",
                           success: function () {
                               row.remove();
                               alert("Pomyślnie usunięto");
                           },
                           error: function (xhr) {
                               alert(xhr.responseText || "Błąd usuwania");
                           }
                       });
                   }
               });

                   // 🔹 Otwieranie modala dodawania wersji
        $(document).on("click", ".add-version-btn", function () {
            var modelRow = $(this).closest("tr");
            var modelId = modelRow.data("id");

            // Zapisz ID modelu w ukrytym polu modala
            $("#addVersionModelId").val(modelId);
            $("#addVersionName").val("");
            $("#errorAddVersion").addClass("d-none").text("");

            var modal = new bootstrap.Modal(document.getElementById("addVersionModal"));
            modal.show();
        });

        // 🔹 Zapis nowej wersji przez AJAX
        $("#saveNewVersion").click(function () {
            var name = $("#addVersionName").val().trim();
            var modelId = $("#addVersionModelId").val();

            // Znajdź wiersz modelu po ID
            var modelRow = $("tr[data-id='" + modelId + "']");
            var existingVersions = modelRow.find(".version-text").map(function () {
                return $(this).text().trim().toLowerCase();
            }).get();

            // Walidacja
            if (!name) {
                $("#errorAddVersion").removeClass("d-none").text("Nazwa jest wymagana");
                return;
            }

            if (existingVersions.includes(name.toLowerCase())) {
                $("#errorAddVersion").removeClass("d-none").text("Taka wersja już istnieje dla tego modelu");
                return;
            }

            $("#errorAddVersion").addClass("d-none");

            var formData = new FormData();
            formData.append("Name", name);
            formData.append("CarModelId", modelId);

            $.ajax({
                url: "/Admin/CreateVersion",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    $("#addVersionModal").modal("hide");
                    alert("Wersja została dodana!");
                    location.reload();
                },
                error: function (xhr) {
                    $("#errorAddVersion").removeClass("d-none").text("❌ Błąd podczas dodawania wersji.");
                    console.error("❌ Error:", xhr.responseText);
                }
            });
        });


    </script>
}